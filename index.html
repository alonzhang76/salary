<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工资表填写系统</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- SheetJS for Excel handling -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- 统一的 Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1a56db',
            secondary: '#6b7280',
            success: '#10b981',
            danger: '#ef4444',
            warning: '#f59e0b',
            info: '#3b82f6',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .table-fixed-layout {
        table-layout: fixed;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      /* 移除number输入框的微调按钮 */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
  <!-- 顶部导航栏 -->
  <header class="bg-primary text-white shadow-md">
    <div class="container mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center space-x-2">
        <i class="fa fa-money text-xl"></i>
        <h1 class="text-xl font-bold">工资表填写系统</h1>
      </div>
      
      <!-- 年月选择器 -->
      <div class="flex items-center space-x-3 bg-white/10 px-3 py-2 rounded-md">
        <label for="salaryYear" class="text-sm">年份:</label>
        <select id="salaryYear" class="bg-primary/30 border-none text-white focus:outline-none rounded px-2 py-1">
          <!-- 年份选项将通过JS生成 -->
        </select>
        <label for="salaryMonth" class="text-sm">月份:</label>
        <select id="salaryMonth" class="bg-primary/30 border-none text-white focus:outline-none rounded px-2 py-1">
          <!-- 月份选项将通过JS生成 -->
        </select>
        <button id="loadSalaryBtn" class="bg-white text-primary px-3 py-1 rounded text-sm hover:bg-gray-100 transition-colors">
          <i class="fa fa-folder-open mr-1"></i>加载
        </button>
      </div>
      
      <div class="flex items-center space-x-4">
        <button id="addEmployeeBtn" class="bg-white text-primary px-4 py-2 rounded-md hover:bg-gray-100 transition-colors flex items-center">
          <i class="fa fa-plus mr-2"></i>添加新员工
        </button>
        <button id="employeeImportBtn" class="bg-white text-primary px-4 py-2 rounded-md hover:bg-gray-100 transition-colors flex items-center">
          <i class="fa fa-download mr-2"></i>导入员工
        </button>
        <button id="employeeExportBtn" class="bg-white text-primary px-4 py-2 rounded-md hover:bg-gray-100 transition-colors flex items-center">
          <i class="fa fa-upload mr-2"></i>导出员工
        </button>
      </div>
    </div>
  </header>



  <!-- 主要内容区域 -->
  <main class="container mx-auto px-4 py-6">
    <!-- 页面标题和说明 -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">
        <span id="currentSalaryPeriod">2023年10月</span> 工资表填写
      </h2>
      <p class="text-gray-600">从左侧员工列表中选择员工，然后在右侧填写工资信息</p>
    </div>

    <!-- 主要内容区 - 左右布局 -->
    <div class="flex flex-col lg:flex-row gap-6">
      <!-- 左侧员工选择区 -->
      <div class="lg:w-1/4 bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-lg font-semibold text-gray-800">员工选择</h3>
          <div class="flex space-x-2">
            <button id="selectAllBtn" class="text-sm bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors">
              全选
            </button>
            <button id="deselectAllBtn" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">
              取消全选
            </button>
          </div>
        </div>
        
        <!-- 员工统计信息 -->
        <div class="mb-4 bg-blue-50 p-2 rounded-md">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">员工总数：</span>
            <span id="totalEmployeeCount" class="font-medium">0</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">在职员工：</span>
            <span id="activeEmployeeCount" class="font-medium text-success">0</span>
          </div>
        </div>
        
        <!-- 搜索框 -->
        <div class="relative mb-4">
          <input type="text" id="employeeSearch" placeholder="搜索员工..." 
                 class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          <i class="fa fa-search absolute right-3 top-3 text-gray-400"></i>
        </div>
        
        <!-- 员工状态筛选 -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">员工状态</label>
          <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="all">全部状态</option>
              <option value="在职" selected>在职</option>
              <option value="离职">离职</option>
          </select>
        </div>
        
        <!-- 公司筛选 -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">选择公司</label>
          <select id="companyFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="all">全部公司</option>
            <option value="普利美常州">普利美常州</option>
            <option value="无锡龙力">无锡龙力</option>
            <option value="普利美劳务派遣">普利美劳务派遣</option>
          </select>
        </div>
        
        <!-- 员工操作按钮组 -->
        <div class="mb-4 flex space-x-2">
          <button id="viewSelectedBtn" class="flex-1 text-sm bg-info text-white px-3 py-2 rounded hover:bg-info/90 transition-colors flex items-center justify-center">
            <i class="fa fa-eye mr-1"></i>查看
          </button>
          <button id="editSelectedBtn" class="flex-1 text-sm bg-primary text-white px-3 py-2 rounded hover:bg-primary/90 transition-colors flex items-center justify-center">
            <i class="fa fa-pencil mr-1"></i>编辑
          </button>
          <button id="deleteSelectedBtn" class="flex-1 text-sm bg-danger text-white px-3 py-2 rounded hover:bg-danger/90 transition-colors flex items-center justify-center">
            <i class="fa fa-trash mr-1"></i>删除
          </button>
          <button id="clearSelectedBtn" class="flex-1 text-sm bg-red-100 text-red-700 px-3 py-2 rounded hover:bg-red-200 transition-colors flex items-center justify-center">
      <i class="fa fa-trash mr-1"></i>清空
          </button>
        </div>
        
        <!-- 员工列表 -->
        <div class="max-h-[600px] overflow-y-auto custom-scrollbar">
          <ul id="employeeList" class="divide-y divide-gray-200">
            <!-- 员工列表项将通过JavaScript动态生成 -->
            <li class="py-4 text-center text-gray-500">
              <i class="fa fa-info-circle mr-2"></i>暂无员工数据，请添加员工
            </li>
          </ul>
        </div>
      </div>

      <!-- 右侧工资表填写区 -->
      <div class="lg:w-3/4 bg-white rounded-lg shadow p-4">
        <!-- 待办事项模块 -->
        <div class="mb-6 bg-blue-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
              <i class="fa fa-tasks text-primary mr-2"></i>待办事项
            </h3>
            <button id="addTodoBtn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1 rounded text-sm flex items-center">
              <i class="fa fa-plus mr-1"></i>添加待办
            </button>
          </div>
          <div class="mb-3">
            <input type="text" id="todoSearch" placeholder="搜索待办事项..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
          </div>
          <div id="todoList" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
            <!-- 待办事项将通过JavaScript动态生成 -->
            <div class="text-gray-500 text-center py-4">
              <i class="fa fa-info-circle mr-2"></i>暂无待办事项
            </div>
          </div>
        </div>
        
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">工资表填写</h3>
            <div class="flex items-center gap-4">
              <div>
                <span class="text-sm text-gray-500">当前公司：</span>
                <span id="currentCompanyDisplay" class="text-sm font-medium text-primary">全部</span>
              </div>
              <label id="importExcelBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors cursor-pointer">
                <i class="fa fa-upload mr-1"></i>导入
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="hidden">
              </label>
              <button id="saveToSummaryBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition-colors">
                <i class="fa fa-save mr-1"></i>保存到汇总
              </button>
            </div>
          </div>
        
        <!-- 工资表表格 -->
        <div class="overflow-x-auto custom-scrollbar">
          <table id="salaryTable" class="w-full border-collapse whitespace-nowrap">
            <thead>
              <tr class="bg-gray-100">
                <th class="px-2 py-1 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-[-80px] bg-gray-100 z-10">
                  <input type="checkbox" id="salaryTableSelectAll">
                </th>
                <th class="px-2 py-1 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-[-20px] bg-gray-100 z-10">工号</th>
                <th class="px-2 py-1 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-100 z-10">姓名</th>
                <th class="px-2 py-1 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">身份证号</th>
                <th class="px-2 py-1 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">手机号</th>
                <th class="px-2 py-1 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">卡号</th>
                <th class="px-2 py-1 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">所属公司</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">出勤天数</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">基本工资</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">绩效奖</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">房贴</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">其它补贴</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">年终奖</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">代扣个人社保</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">代扣公积金</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">扣借款</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">代扣个税</th>
                <th class="px-2 py-1 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 font-bold">实发工资</th>
                <th class="px-2 py-1 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
              </tr>
            </thead>
            <tbody id="salaryTableBody">
              <!-- 工资表内容将通过JavaScript动态生成 -->
              <tr class="text-gray-500 text-center">
                <td colspan="19" class="px-2 py-1 border border-gray-300">
                  <i class="fa fa-info-circle mr-2"></i>请从左侧选择员工
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- 工资汇总表格 -->
        <div class="mt-8">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">工资汇总</h3>
            <div class="flex items-center gap-3">
              <button id="searchSummaryBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
                <i class="fa fa-search mr-1"></i>查询
              </button>
              <button id="generateSalaryReportBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded transition-colors">
                <i class="fa fa-file-text-o mr-1"></i>生成工资明细表
              </button>
              <button id="exportJsonBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">
                <i class="fa fa-download mr-1"></i>导出JSON
              </button>
              <button id="importJsonBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
                <i class="fa fa-upload mr-1"></i>导入JSON
              </button>
              <button id="clearSummaryBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors">
                <i class="fa fa-trash mr-1"></i>清空汇总
              </button>
            </div>
          </div>
          <div class="mb-4 flex justify-between items-center">
            <div id="summaryStats" class="text-gray-600">
              共 <span id="totalRecords">0</span> 条记录
            </div>
          </div>
          <div class="overflow-x-auto custom-scrollbar">
            <table id="salarySummaryTable" class="w-full border-collapse whitespace-nowrap">
              <thead>
                <tr class="bg-gray-100">
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-100 z-10">
                    <input type="checkbox" id="summaryTableSelectAll">
                  </th>
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-[40px] bg-gray-100 z-10">年/月</th>
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-[120px] bg-gray-100 z-10">工号</th>
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-[200px] bg-gray-100 z-10">姓名</th>
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">身份证号</th>
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">手机号</th>
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">卡号</th>
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">所属公司</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">出勤天数</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">基本工资</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">绩效奖</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">房贴</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">其它补贴</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">年终奖</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">代扣个人社保</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">代扣公积金</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">扣借款</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">代扣个税</th>
                  <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 font-bold">实发工资</th>
                  <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                  <th class="px-3 py-2 border border-gray-300 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
              </thead>
              <tbody id="salarySummaryTableBody">
                <tr class="text-gray-500 text-center">
                  <td colspan="22" class="px-3 py-8 border border-gray-300">
                    <i class="fa fa-info-circle mr-2"></i>暂无汇总数据
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- 分页控件 -->
          <div id="paginationControls" class="mt-4 flex justify-between items-center hidden">
            <div class="text-sm text-gray-600">
              显示 <span id="startRecord">0</span>-<span id="endRecord">0</span> 条，共 <span id="paginationTotal">0</span> 条
            </div>
            <div class="flex items-center gap-2">
              <select id="pageSizeSelect" class="px-2 py-1 border border-gray-300 rounded text-sm">
                <option value="10">10条/页</option>
                <option value="20">20条/页</option>
                <option value="50">50条/页</option>
                <option value="100">100条/页</option>
              </select>
              <div class="flex items-center gap-1">
                <button id="prevPage" class="px-2 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                  <i class="fa fa-chevron-left"></i>
                </button>
                <span id="currentPage" class="px-2 py-1 text-sm">1</span>
                <button id="nextPage" class="px-2 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                  <i class="fa fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- 工资统计图表 -->
          <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-lg font-semibold text-gray-800">工资统计图表</h3>
              <div class="flex items-center gap-3">
                <div class="relative inline-block">
                  <select id="chartTimeRange" class="bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none">
                    <option value="year">按年查看</option>
                    <option value="month">按月查看</option>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <i class="fa fa-chevron-down text-xs"></i>
                  </div>
                </div>
                <div class="relative inline-block">
                  <select id="chartYearFilter" class="bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none">
                    <option value="2020">2020年</option>
                    <option value="2021">2021年</option>
                    <option value="2022">2022年</option>
                    <option value="2023">2023年</option>
                    <option value="2024">2024年</option>
                    <option value="2025" selected>2025年</option>
                    <option value="2026">2026年</option>
                    <option value="2027">2027年</option>
                    <option value="2028">2028年</option>
                    <option value="2029">2029年</option>
                    <option value="2030">2030年</option>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <i class="fa fa-chevron-down text-xs"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="h-80 w-full">
              <canvas id="salaryChart"></canvas>
            </div>
            <div id="chartNoData" class="h-80 w-full flex items-center justify-center text-gray-400 hidden">
              <div class="text-center">
                <i class="fa fa-bar-chart text-4xl mb-3"></i>
                <p>暂无统计数据</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 添加新员工模态框 -->
  <div id="addEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">添加新员工</h3>
          <button id="closeAddEmployeeModal" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">工号 <span class="text-danger">*</span></label>
            <input type="text" id="newEmpId" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" readonly required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">姓名 <span class="text-danger">*</span></label>
            <input type="text" id="newEmpName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">手机号</label>
            <input type="text" id="newEmpPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">身份证号 <span class="text-danger">*</span></label>
            <input type="text" id="newEmpIdCard" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">所属公司 <span class="text-danger">*</span></label>
            <select id="newEmpCompany" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
              <option value="">请选择公司</option>
              <option value="普利美常州">普利美常州</option>
              <option value="无锡龙力">无锡龙力</option>
              <option value="普利美劳务派遣">普利美劳务派遣</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">所属部门 <span class="text-danger">*</span></label>
            <select id="newEmpDepartment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
              <option value="行政部">行政部</option>
              <option value="生产部">生产部</option>
              <option value="其它部门">其它部门</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">入职日期 <span class="text-danger">*</span></label>
            <input type="date" id="newEmpHireDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">离职日期</label>
            <input type="date" id="newEmpLeaveDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">状态 <span class="text-danger">*</span></label>
            <input type="text" id="newEmpStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" value="在职" readonly required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">职位</label>
            <select id="newEmpPosition" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="">请选择职位</option>
              <option value="经理">经理</option>
              <option value="生产主管">生产主管</option>
              <option value="技术员">技术员</option>
              <option value="操作工">操作工</option>
              <option value="保洁">保洁</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">开户行 <span class="text-danger">*</span></label>
            <input type="text" id="newEmpBank" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">卡号 <span class="text-danger">*</span></label>
            <input type="text" id="newEmpBankCard" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
            <textarea id="newEmpRemarks" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button id="cancelAddEmployee" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
            取消
          </button>
          <button id="confirmAddEmployee" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
            确认添加
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 员工导入模态框 -->
  <div id="employeeImportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">导入员工数据</h3>
          <button id="closeEmployeeImportModal" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <div class="mb-6">
          <p class="text-gray-600 mb-4">支持导入Excel格式的员工数据，包含以下字段：</p>
          <div class="bg-gray-50 p-4 rounded-md text-sm text-gray-700">
            <p class="mb-2 font-medium">必填字段：工号、姓名、手机号、身份证号、卡号、所属公司</p>
            <p class="mb-2 font-medium">可选字段：职位、开户行、入职日期、离职日期、备注</p>
            <p class="text-gray-600">说明：如果填写了离职日期，员工状态将自动设置为"离职"</p>
          </div>
        </div>
        
        <!-- 下载模板按钮 -->
        <div class="mb-4">
          <button id="downloadTemplateBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors flex items-center">
            <i class="fa fa-file-excel-o mr-2"></i>下载导入模板
          </button>
        </div>
        
        <!-- 文件上传区域 -->
        <div id="fileDropArea" class="border-2 border-dashed border-gray-300 rounded-md p-8 text-center mb-6 cursor-pointer hover:border-primary transition-colors">
          <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
          <p class="text-gray-600 mb-2">拖放Excel文件到此处，或点击选择文件</p>
          <p class="text-gray-400 text-sm">支持 .xlsx 格式</p>
          <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden">
        </div>
        
        <!-- 导入选项 -->
        <div class="mb-6">
          <label class="inline-flex items-center">
            <input type="radio" name="importMode" value="replace" class="text-primary focus:ring-primary" checked>
            <span class="ml-2">替换现有员工数据</span>
          </label>
          <br>
          <label class="inline-flex items-center mt-2">
            <input type="radio" name="importMode" value="merge" class="text-primary focus:ring-primary">
            <span class="ml-2">合并到现有员工数据（相同工号会被更新）</span>
          </label>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button id="cancelImport" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
            取消
          </button>
          <button id="confirmImport" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
            确认导入
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 导入结果模态框 -->
  <div id="importResultModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">导入结果</h3>
          <button id="closeImportResultModal" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <div id="importSuccess" class="mb-4 hidden">
          <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-md mb-4 flex items-center">
            <i class="fa fa-check-circle text-xl mr-3"></i>
            <div>
              <p class="font-medium">导入成功</p>
              <p class="text-sm" id="importSuccessMessage"></p>
            </div>
          </div>
        </div>
        
        <div id="importError" class="mb-4 hidden">
          <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md mb-4 flex items-center">
            <i class="fa fa-exclamation-circle text-xl mr-3"></i>
            <div>
              <p class="font-medium">导入失败</p>
              <p class="text-sm" id="importErrorMessage"></p>
            </div>
          </div>
        </div>
        
        <div id="importWarnings" class="mb-4 hidden">
          <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-md mb-4">
            <p class="font-medium flex items-center"><i class="fa fa-exclamation-triangle mr-2"></i>导入警告</p>
            <ul id="importWarningList" class="list-disc list-inside text-sm mt-2"></ul>
          </div>
        </div>
        
        <div class="flex justify-end">
          <button id="closeImportResult" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
            关闭
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 确认加载模态框 -->
  <div id="confirmLoadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">确认加载</h3>
          <button id="closeConfirmLoadModal" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <p class="text-gray-600 mb-6" id="confirmLoadMessage">
          您确定要加载此月份的工资表吗？当前未保存的修改将会丢失。
        </p>
        
        <div class="flex justify-end space-x-3">
          <button id="cancelLoad" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
            取消
          </button>
          <button id="confirmLoad" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
            确认加载
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 提示组件 -->
  <div id="saveSuccessToast" class="fixed bottom-4 right-4 bg-success text-white px-4 py-3 rounded-md shadow-lg flex items-center hidden">
    <i class="fa fa-check-circle mr-2"></i>
    <span>保存成功！</span>
  </div>

  <div id="toastNotification" class="fixed bottom-4 right-4 px-4 py-3 rounded-md shadow-lg flex items-center hidden">
    <i class="fa fa-info-circle mr-2"></i>
    <span id="toastMessage"></span>
  </div>

  <script>
    // 员工数据 - 初始为空
    let employees = [];

    // 工资表数据 - 按年月和公司存储
    let salaryStorage = {};
    let currentSalaryYear = new Date().getFullYear();
    let currentSalaryMonth = new Date().getMonth() + 1; // 月份从1开始
    let currentCompany = 'all'; // 当前选中的公司，默认为全部
    let salaryData = [];
    let isDataModified = false; // 标记数据是否被修改

    // DOM元素
    const employeeList = document.getElementById('employeeList');
    const salaryTableBody = document.getElementById('salaryTableBody');
    const employeeSearch = document.getElementById('employeeSearch');
    const companyFilter = document.getElementById('companyFilter');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    // 导出工资表按钮已移除，相关变量已删除
    const salaryTableSelectAll = document.getElementById('salaryTableSelectAll');
    const currentSalaryPeriod = document.getElementById('currentSalaryPeriod');
    // 历史记录区域已移除，相关变量已删除
    const salaryYear = document.getElementById('salaryYear');
    const salaryMonth = document.getElementById('salaryMonth');
    const loadSalaryBtn = document.getElementById('loadSalaryBtn');
    const currentCompanyDisplay = document.getElementById('currentCompanyDisplay');
    const addEmployeeBtn = document.getElementById('addEmployeeBtn');
    const excelFileInput = document.getElementById('excelFileInput');
    const importExcelBtn = document.getElementById('importExcelBtn');
    
    // 员工导入导出相关元素
    const employeeImportBtn = document.getElementById('employeeImportBtn');
    const employeeExportBtn = document.getElementById('employeeExportBtn');
    const employeeImportModal = document.getElementById('employeeImportModal');
    const closeEmployeeImportModal = document.getElementById('closeEmployeeImportModal');
    const fileDropArea = document.getElementById('fileDropArea');
    const fileInput = document.getElementById('fileInput');
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
    const cancelImport = document.getElementById('cancelImport');
    const confirmImport = document.getElementById('confirmImport');
    const importResultModal = document.getElementById('importResultModal');
    const closeImportResultModal = document.getElementById('closeImportResultModal');
    const closeImportResult = document.getElementById('closeImportResult');
    const importSuccess = document.getElementById('importSuccess');
    const importError = document.getElementById('importError');
    const importWarnings = document.getElementById('importWarnings');
    const importSuccessMessage = document.getElementById('importSuccessMessage');
    const importErrorMessage = document.getElementById('importErrorMessage');
    const importWarningList = document.getElementById('importWarningList');

    // 添加员工模态框元素
    const addEmployeeModal = document.getElementById('addEmployeeModal');
    const closeAddEmployeeModal = document.getElementById('closeAddEmployeeModal');
    const cancelAddEmployee = document.getElementById('cancelAddEmployee');
    const confirmAddEmployee = document.getElementById('confirmAddEmployee');

    // 确认加载模态框元素
    const confirmLoadModal = document.getElementById('confirmLoadModal');
    const closeConfirmLoadModal = document.getElementById('closeConfirmLoadModal');
    const cancelLoad = document.getElementById('cancelLoad');
    const confirmLoad = document.getElementById('confirmLoad');
    const confirmLoadMessage = document.getElementById('confirmLoadMessage');

    // 提示元素
    const saveSuccessToast = document.getElementById('saveSuccessToast');
    const toastNotification = document.getElementById('toastNotification');
    const toastMessage = document.getElementById('toastMessage');

    // 初始化年份和月份选择器
    function initDatePickers() {
      const now = new Date();
      const currentYear = now.getFullYear();
      
      // 生成年份选项 (从2020年到2030年)
      for (let i = 2020; i <= 2030; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        option.style.backgroundColor = '#1a56db'; // primary颜色
        option.style.color = '#ffffff';
        if (i === currentSalaryYear) {
          option.selected = true;
        }
        salaryYear.appendChild(option);
      }
      
      // 生成月份选项
      for (let i = 1; i <= 12; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        option.style.backgroundColor = '#1a56db'; // primary颜色
        option.style.color = '#ffffff';
        if (i === currentSalaryMonth) {
          option.selected = true;
        }
        salaryMonth.appendChild(option);
      }
      
      // 更新当前工资周期显示
      updateCurrentPeriodDisplay();
    }

    // 更新当前工资周期显示
    function updateCurrentPeriodDisplay() {
      currentSalaryPeriod.textContent = `${currentSalaryYear}年${currentSalaryMonth}月`;
    }

    // 加载指定年月的工资表数据
    function loadSalaryData(year, month, skipConfirmation = false) {
      // 检查数据是否被修改
      if (!skipConfirmation && isDataModified) {
        // 显示确认对话框
        confirmLoadMessage.textContent = `您确定要加载${year}年${month}月的工资表吗？当前未保存的修改将会丢失。`;
        confirmLoadModal.classList.remove('hidden');
        
        // 保存要加载的年月，供确认后使用
        confirmLoad.dataset.targetYear = year;
        confirmLoad.dataset.targetMonth = month;
        return;
      }
      
      // 隐藏确认对话框
      confirmLoadModal.classList.add('hidden');
      
      // 更新当前年月
      currentSalaryYear = year;
      currentSalaryMonth = month;
      
      // 更新选择器
      salaryYear.value = year;
      salaryMonth.value = month;
      
      // 更新显示
      updateCurrentPeriodDisplay();
      
      // 从存储中加载数据，如果不存在则初始化空数据
      const key = getSalaryKey(year, month);
      salaryData = salaryStorage[key] ? [...salaryStorage[key]] : [];
      
      // 重置修改标记
      isDataModified = false;
      
      // 刷新工资表
      renderSalaryTable();
      
      // 更新员工列表的选中状态
      renderEmployeeList(getFilteredEmployees());
      
      showToast(`${year}年${month}月工资表已加载`);
    }

    // 保存当前工资表数据
    function saveCurrentSalaryData() {
      const key = getSalaryKey(currentSalaryYear, currentSalaryMonth);
      
      // 深拷贝数据保存
      salaryStorage[key] = JSON.parse(JSON.stringify(salaryData));
      
      // 保存到本地存储
      localStorage.setItem('salaryStorage', JSON.stringify(salaryStorage));
      
      // 更新修改标记
      isDataModified = false;
      
      // 历史记录区域已移除，不再更新历史记录
      
      // 显示保存成功提示
      saveSuccessToast.classList.remove('hidden');
      setTimeout(() => {
        saveSuccessToast.classList.add('hidden');
      }, 3000);
    }

    // 获取工资表数据的存储键
    function getSalaryKey(year, month) {
      return `${year}-${String(month).padStart(2, '0')}`;
    }

    // 历史记录区域已移除，renderHistoryRecords函数已删除

    // 保存按钮已移除，相关函数已删除

    // 渲染员工列表
    function renderEmployeeList(filteredEmployees = employees) {
      employeeList.innerHTML = '';
      // 更新员工统计信息
      updateEmployeeStats();
      
      if (filteredEmployees.length === 0) {
        employeeList.innerHTML = '<li class="py-4 text-center text-gray-500">没有找到匹配的员工</li>';
        return;
      }
      
      filteredEmployees.forEach(employee => {
        const isSelected = salaryData.some(item => item.id === employee.id);
        
        const li = document.createElement('li');
        li.className = 'py-2 flex items-center';
        li.innerHTML = `
          <input type="checkbox" class="employee-checkbox w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded" 
                 data-id="${employee.id}" ${isSelected ? 'checked' : ''}>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-900">${employee.name}</p>
            <p class="text-xs text-gray-500">${employee.company} | ${employee.position || '无职位'}</p>
          </div>
        `;
        
        employeeList.appendChild(li);
      });

      // 添加员工选择事件
      document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handleEmployeeSelect);
      });
    }

    // 处理员工选择
    function handleEmployeeSelect(e) {
      const employeeId = e.target.dataset.id;
      const employee = employees.find(emp => emp.id === employeeId);
      
      if (e.target.checked) {
        // 添加到工资表
        if (!salaryData.some(item => item.id === employeeId)) {
          // 需要自动设置社保的员工名单
          const socialSecurityEmployees = ['吴耀华', '李承武', '姚亚梅', '肖满', '张燕', '顾亚伦', '王云海', '陈凯', '梁浩杰', '吴利成', '林仕军', '于艳芳'];
          // 需要自动设置房贴的员工名单
          const housingAllowanceEmployees = ['吴耀华', '李承武', '刘跟党', '吴利成', '林仕军', '王云海', '沈月红'];
          // 特殊员工处理：许小成
          let socialSecurity = 0;
          let providentFund = 0;
          let housingAllowance = 0;
          
          if (employee.name === '许小成') {
            socialSecurity = 840;
            providentFund = 500;
          } else if (socialSecurityEmployees.includes(employee.name)) {
            socialSecurity = 519.96;
          } else if (employee.name === '陈淑敏') {
            socialSecurity = 735;
          }
          
          // 自动设置房贴
          if (housingAllowanceEmployees.includes(employee.name)) {
            housingAllowance = 200;
          }
          
          salaryData.push({
            id: employee.id,
            name: employee.name,
            idCard: employee.idCard,
            phone: employee.phone,
            bankCard: employee.bankCard,
            company: employee.company,
            attendanceDays: 0,
            basicSalary: 0,
            performanceBonus: 0,
            housingAllowance: 0,
            otherAllowance: 0,
            yearEndBonus: 0,
            socialSecurity: socialSecurity,
            providentFund: providentFund,
            loanDeduction: 0,
            incomeTax: 0,
            netSalary: 0,
            remarks: ''
          });
          
          isDataModified = true;
        }
      } else {
        // 从工资表中移除
        salaryData = salaryData.filter(item => item.id !== employeeId);
        
        isDataModified = true;
      }
      
      renderSalaryTable();
    }

    // 更新员工统计信息
    function updateEmployeeStats() {
      const totalCount = employees.length;
      // 默认将没有status字段的员工视为在职
      const activeCount = employees.filter(emp => !emp.status || emp.status === '在职').length;
      
      const totalCountElement = document.getElementById('totalEmployeeCount');
      const activeCountElement = document.getElementById('activeEmployeeCount');
      
      if (totalCountElement && activeCountElement) {
        totalCountElement.textContent = totalCount;
        activeCountElement.textContent = activeCount;
      }
    }
    
    // 渲染工资表
    function renderSalaryTable() {
      // 根据当前选择的公司筛选数据
      let filteredSalaryData = salaryData;
      if (currentCompany !== 'all') {
        filteredSalaryData = salaryData.filter(item => item.company === currentCompany);
      }
      
      if (filteredSalaryData.length === 0) {
        salaryTableBody.innerHTML = `
          <tr class="text-gray-500 text-center">
            <td colspan="19" class="px-3 py-8 border border-gray-300">
              <i class="fa fa-info-circle mr-2"></i>请从左侧选择员工
            </td>
          </tr>
        `;
        return;
      }
      
      salaryTableBody.innerHTML = '';
      
      filteredSalaryData.forEach((employee, index) => {
        const tr = document.createElement('tr');
        tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        tr.innerHTML = `
          <td class="px-3 py-2 border border-gray-300 sticky left-[-80px] ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} z-0">
            <input type="checkbox" class="salary-table-checkbox w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded" 
                   data-id="${employee.id}">
          </td>
          <td class="px-3 py-2 border border-gray-300 font-medium sticky left-[-20px] ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} z-0">${employee.id}</td>
          <td class="px-3 py-2 border border-gray-300 font-medium sticky left-0 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} z-0">${employee.name}</td>
          <td class="px-3 py-2 border border-gray-300">${employee.idCard}</td>
          <td class="px-3 py-2 border border-gray-300">${employee.phone}</td>
          <td class="px-3 py-2 border border-gray-300">${employee.bankCard}</td>
          <td class="px-3 py-2 border border-gray-300">${employee.company}</td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;" 
                   value="${employee.attendanceDays || 0}" 
                   data-field="attendanceDays" data-id="${employee.id}" 
                   oninput="updateSalaryData(this)" min="0" max="31">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="basicSalary" data-id="${employee.id}" value="${employee.basicSalary}">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="performanceBonus" data-id="${employee.id}" value="${employee.performanceBonus}">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="housingAllowance" data-id="${employee.id}" value="${employee.housingAllowance}">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="otherAllowance" data-id="${employee.id}" value="${employee.otherAllowance}">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="yearEndBonus" data-id="${employee.id}" value="${employee.yearEndBonus}">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="socialSecurity" data-id="${employee.id}" value="${employee.socialSecurity}">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="providentFund" data-id="${employee.id}" value="${employee.providentFund}">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="loanDeduction" data-id="${employee.id}" value="${employee.loanDeduction}">
          </td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="number" class="text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="incomeTax" data-id="${employee.id}" value="${employee.incomeTax}">
          </td>
          <td class="px-3 py-2 border border-gray-300 font-bold text-right text-primary">${employee.netSalary.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300">
            <input type="text" class="px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" style="width: auto; min-width: 60px;"
                   data-field="remarks" data-id="${employee.id}" value="${employee.remarks}">
          </td>
        `;
        
        salaryTableBody.appendChild(tr);
      });

      // 自动调整输入框宽度函数（不再缩小文字）
      function adjustFontSize(element, text) {
        // 设置固定字体大小，不再缩小
        element.style.fontSize = '14px';
        
        // 创建一个临时span元素来测量文本宽度
        const tempSpan = document.createElement('span');
        tempSpan.textContent = text;
        tempSpan.style.fontFamily = window.getComputedStyle(element).fontFamily;
        tempSpan.style.fontSize = '14px'; // 保持固定字体大小
        tempSpan.style.position = 'absolute';
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.whiteSpace = 'nowrap';
        tempSpan.style.padding = '2px';
        document.body.appendChild(tempSpan);
        
        // 获取文本宽度
        const textWidth = tempSpan.offsetWidth;
        
        // 根据文本宽度调整输入框宽度，添加一些额外空间
        const newWidth = Math.max(60, textWidth + 10); // 最小60px，加10px内边距
        element.style.width = `${newWidth}px`;
        
        // 移除临时元素
        document.body.removeChild(tempSpan);
      }
      
      // 调整表格中长文本字段的字体大小
      function adjustTableTextSizes() {
        // 调整身份证号、手机号、卡号等文本字段
        const textCells = document.querySelectorAll('#salaryTableBody td:nth-child(4), #salaryTableBody td:nth-child(5), #salaryTableBody td:nth-child(6)');
        textCells.forEach(cell => {
          const text = cell.textContent.trim();
          if (text) {
            adjustFontSize(cell, text);
          }
        });
      }
      
      // 添加工资表数据变更事件和输入事件
      document.querySelectorAll('#salaryTableBody input[type="number"], #salaryTableBody input[type="text"]').forEach(input => {
        input.addEventListener('change', handleSalaryDataChange);
        input.addEventListener('input', function() {
          adjustFontSize(this, this.value);
        });
        
        // 初始化时也调整一次
        if (input.value) {
          adjustFontSize(input, input.value);
        }
      });
      
      // 计算合计数据
      if (filteredSalaryData.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.className = 'bg-gray-100 font-bold';
        
        // 计算各字段合计
        const totals = {
          attendanceDays: filteredSalaryData.reduce((sum, emp) => sum + (emp.attendanceDays || 0), 0),
          basicSalary: filteredSalaryData.reduce((sum, emp) => sum + emp.basicSalary, 0),
          performanceBonus: filteredSalaryData.reduce((sum, emp) => sum + emp.performanceBonus, 0),
          housingAllowance: filteredSalaryData.reduce((sum, emp) => sum + emp.housingAllowance, 0),
          otherAllowance: filteredSalaryData.reduce((sum, emp) => sum + emp.otherAllowance, 0),
          yearEndBonus: filteredSalaryData.reduce((sum, emp) => sum + emp.yearEndBonus, 0),
          socialSecurity: filteredSalaryData.reduce((sum, emp) => sum + emp.socialSecurity, 0),
          providentFund: filteredSalaryData.reduce((sum, emp) => sum + emp.providentFund, 0),
          loanDeduction: filteredSalaryData.reduce((sum, emp) => sum + emp.loanDeduction, 0),
          incomeTax: filteredSalaryData.reduce((sum, emp) => sum + emp.incomeTax, 0),
          netSalary: filteredSalaryData.reduce((sum, emp) => sum + emp.netSalary, 0)
        };
        
        totalRow.innerHTML = `
          <td colspan="7" class="px-3 py-2 border border-gray-300 text-center">合计</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.attendanceDays}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.basicSalary.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.performanceBonus.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.housingAllowance.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.otherAllowance.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.yearEndBonus.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.socialSecurity.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.providentFund.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.loanDeduction.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right">${totals.incomeTax.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 font-bold text-right text-primary">${totals.netSalary.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300"></td>
        `;
        
        salaryTableBody.appendChild(totalRow);
      }
      
      // 渲染完成后调整表格中长文本字段的字体大小
      adjustTableTextSizes();
      
      // 添加工资表复选框事件监听器
      addSalaryTableCheckboxListeners();
    }

    // 处理工资数据变更
    function handleSalaryDataChange(e) {
      const employeeId = e.target.dataset.id;
      const field = e.target.dataset.field;
      const value = field === 'remarks' ? e.target.value : parseFloat(e.target.value) || 0;
      
      const index = salaryData.findIndex(item => item.id === employeeId);
      if (index !== -1) {
        salaryData[index][field] = value;
        calculateNetSalary(index);
        
        isDataModified = true;
        // 保存按钮已移除，不再更新状态
        
        // 重新渲染整个表格，确保合计行能够自动更新
        renderSalaryTable();
      }
    }

    // 计算实发工资
    function calculateNetSalary(index) {
      const employee = salaryData[index];
      
      // 计算应发工资
      const grossSalary = 
        employee.basicSalary + 
        employee.performanceBonus + 
        employee.housingAllowance + 
        employee.otherAllowance + 
        employee.yearEndBonus;
      
      // 计算扣除项
      const totalDeductions = 
        employee.socialSecurity + 
        employee.providentFund + 
        employee.loanDeduction + 
        employee.incomeTax;
      
      // 计算实发工资
      employee.netSalary = grossSalary - totalDeductions;
      
      // 不再单独更新DOM，而是通过重新渲染整个表格来更新
    }

    // 搜索员工
    function searchEmployees() {
      const searchTerm = employeeSearch.value.toLowerCase();
      const company = companyFilter.value;
      const status = statusFilter.value;
      
      // 更新当前公司
      currentCompany = company;
      currentCompanyDisplay.textContent = company === 'all' ? '全部' : company;
      
      let filteredEmployees = employees;
      
      if (searchTerm) {
        filteredEmployees = filteredEmployees.filter(employee => 
          employee.name.toLowerCase().includes(searchTerm) || 
          employee.id.toLowerCase().includes(searchTerm) ||
          employee.phone.toLowerCase().includes(searchTerm)
        );
      }
      
      if (company !== 'all') {
        filteredEmployees = filteredEmployees.filter(employee => employee.company === company);
      }
      
      if (status !== 'all') {
        filteredEmployees = filteredEmployees.filter(employee => employee.status === status);
      }
      
      renderEmployeeList(filteredEmployees);
      renderSalaryTable(); // 重新渲染工资表以反映公司筛选
    }

    // 全选员工
    function selectAllEmployees() {
      const filteredEmployees = getFilteredEmployees();
      let hasChanges = false;
      
      filteredEmployees.forEach(employee => {
        if (!salaryData.some(item => item.id === employee.id)) {
          // 需要自动设置社保的员工名单
          const socialSecurityEmployees = ['吴耀华', '李承武', '姚亚梅', '肖满', '张燕', '顾亚伦', '王云海', '陈凯', '梁浩杰', '吴利成', '林仕军', '于艳芳'];
          // 需要自动设置房贴的员工名单
          const housingAllowanceEmployees = ['吴耀华', '李承武', '刘跟党', '吴利成', '林仕军', '王云海', '沈月红'];
          // 特殊员工处理：许小成
          let socialSecurity = 0;
          let providentFund = 0;
          let housingAllowance = 0;
          
          if (employee.name === '许小成') {
            socialSecurity = 840;
            providentFund = 500;
          } else if (socialSecurityEmployees.includes(employee.name)) {
            socialSecurity = 519.96;
          } else if (employee.name === '陈淑敏') {
            socialSecurity = 735;
          }
          
          // 设置房贴
          if (housingAllowanceEmployees.includes(employee.name)) {
            housingAllowance = 200;
          }
          
          salaryData.push({
            id: employee.id,
            name: employee.name,
            idCard: employee.idCard,
            phone: employee.phone,
            bankCard: employee.bankCard,
            company: employee.company,
            basicSalary: 0,
            performanceBonus: 0,
            housingAllowance: housingAllowance,
            otherAllowance: 0,
            yearEndBonus: 0,
            socialSecurity: socialSecurity,
            providentFund: providentFund,
            loanDeduction: 0,
            incomeTax: 0,
            netSalary: 0,
            remarks: ''
          });
          hasChanges = true;
        }
      });
      
      if (hasChanges) {
        isDataModified = true;
        // 保存按钮已移除，不再更新状态
      }
      
      renderEmployeeList(filteredEmployees);
      renderSalaryTable();
    }

    // 取消全选员工
    function deselectAllEmployees() {
      const filteredEmployees = getFilteredEmployees();
      const initialLength = salaryData.length;
      
      salaryData = salaryData.filter(item => !filteredEmployees.some(emp => emp.id === item.id));
      
      if (salaryData.length !== initialLength) {
        isDataModified = true;
        // 保存按钮已移除，不再更新状态
      }
      
      renderEmployeeList(filteredEmployees);
      renderSalaryTable();
    }

    // 获取筛选后的员工
    function getFilteredEmployees() {
      const searchTerm = employeeSearch.value.toLowerCase();
      const company = companyFilter.value;
      const status = statusFilter.value;
      
      let filteredEmployees = employees;
      
      if (searchTerm) {
        filteredEmployees = filteredEmployees.filter(employee => 
          employee.name.toLowerCase().includes(searchTerm) || 
          employee.id.toLowerCase().includes(searchTerm) ||
          employee.phone.toLowerCase().includes(searchTerm)
        );
      }
      
      if (company !== 'all') {
        filteredEmployees = filteredEmployees.filter(employee => employee.company === company);
      }
      
      if (status !== 'all') {
        filteredEmployees = filteredEmployees.filter(employee => employee.status === status);
      }
      
      return filteredEmployees;
    }

    // 导出工资表按钮已移除，exportExcel函数已删除

    // 工资表全选/取消全选
    function toggleSalaryTableSelectAll() {
      const isChecked = salaryTableSelectAll.checked;
      
      document.querySelectorAll('.salary-table-checkbox').forEach(checkbox => {
        checkbox.checked = isChecked;
        // 更新行背景色
        updateRowBackgroundColor(checkbox);
      });
    }
    
    // 更新行背景色
    function updateRowBackgroundColor(checkbox) {
      const row = checkbox.closest('tr');
      if (row && !row.classList.contains('bg-gray-100')) {
        if (checkbox.checked) {
          row.classList.add('bg-green-100');
        } else {
          row.classList.remove('bg-green-100');
        }
      }
    }
    
    // 为工资表复选框添加事件监听器
    function addSalaryTableCheckboxListeners() {
      document.querySelectorAll('.salary-table-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateRowBackgroundColor(this);
          
          // 当复选框选中时，查找员工最后一次的基本工资
          if (this.checked) {
            const row = this.closest('tr');
            const employeeId = row.querySelector('td:nth-child(2)').textContent.trim(); // 获取工号
            const basicSalaryInput = row.querySelector('input[data-field="basicSalary"]'); // 获取基本工资输入框
            
            if (employeeId && basicSalaryInput) {
              const lastBasicSalary = findLastEmployeeBasicSalary(employeeId);
              if (lastBasicSalary !== null) {
                // 以提示词方式显示在基本工资输入框中
                basicSalaryInput.value = lastBasicSalary.toFixed(2);
                basicSalaryInput.setAttribute('title', `系统自动填充：最后一次录入的基本工资`);
                // 触发change事件以更新相关数据
                basicSalaryInput.dispatchEvent(new Event('change'));
              }
            }
          }
        });
      });
    }
    
    // 查找员工最后一次录入的基本工资
    function findLastEmployeeBasicSalary(employeeId) {
      // 从localStorage获取工资汇总数据
      const storedData = localStorage.getItem('salarySummaryData');
      if (!storedData) return null;
      
      const summaryData = JSON.parse(storedData);
      
      // 筛选该员工的所有工资记录
      const employeeRecords = summaryData.filter(record => record.employeeId === employeeId);
      
      if (employeeRecords.length === 0) return null;
      
      // 按年份和月份降序排序，获取最新的记录
      employeeRecords.sort((a, b) => {
        const keyA = a.year * 100 + a.month;
        const keyB = b.year * 100 + b.month;
        return keyB - keyA;
      });
      
      // 返回最新记录的基本工资
      return employeeRecords[0].basicSalary;
    }
    
    // 为工资汇总表复选框添加事件监听器
    function addSummaryTableCheckboxListeners() {
      document.querySelectorAll('.summary-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateRowBackgroundColor(this);
        });
      });
    }

    // 显示提示消息
    function showToast(message, isError = false) {
      toastMessage.textContent = message;
      toastNotification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-md shadow-lg flex items-center ${isError ? 'bg-danger text-white' : 'bg-success text-white'}`;
      toastNotification.classList.remove('hidden');
      
      setTimeout(() => {
        toastNotification.classList.add('hidden');
      }, 3000);
    }

    // 添加新员工
    function addNewEmployee() {
      const id = document.getElementById('newEmpId').value.trim();
      const name = document.getElementById('newEmpName').value.trim();
      const phone = document.getElementById('newEmpPhone').value.trim();
      const idCard = document.getElementById('newEmpIdCard').value.trim();
      const company = document.getElementById('newEmpCompany').value;
      const department = document.getElementById('newEmpDepartment').value;
      const hireDate = document.getElementById('newEmpHireDate').value;
      const leaveDate = document.getElementById('newEmpLeaveDate').value;
      const status = document.getElementById('newEmpStatus').value;
      const position = document.getElementById('newEmpPosition').value.trim();
      const bank = document.getElementById('newEmpBank').value.trim();
      const bankCard = document.getElementById('newEmpBankCard').value.trim();
      const remarks = document.getElementById('newEmpRemarks').value.trim();
      
      // 验证必填字段
      if (!id || !name || !idCard || !company || !department || !hireDate || !status || !bank || !bankCard) {
        showToast('请填写所有必填字段', true);
        return;
      }
      
      // 验证手机号格式（如果有填写）
      if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
        showToast('手机号格式不正确', true);
        return;
      }
      
      // 验证工号是否已存在
      if (employees.some(emp => emp.id === id)) {
        showToast('该工号已存在，请使用其他工号', true);
        return;
      }
      
      // 创建新员工对象
      const newEmployee = {
        department,
        hireDate,
        leaveDate,
        status,
        id,
        name,
        phone,
        idCard,
        company,
        position,
        bank,
        bankCard,
        remarks
      };
      
      // 添加到员工列表
      employees.push(newEmployee);
      
      // 保存到本地存储
      localStorage.setItem('salary_employees', JSON.stringify(employees));
      
      // 刷新员工列表
      renderEmployeeList(getFilteredEmployees());
      // 更新员工统计信息
      updateEmployeeStats();
      
      // 关闭模态框并重置表单
      addEmployeeModal.classList.add('hidden');
      document.getElementById('newEmpId').value = '';
      document.getElementById('newEmpName').value = '';
      document.getElementById('newEmpPhone').value = '';
      document.getElementById('newEmpIdCard').value = '';
      document.getElementById('newEmpCompany').value = '';
      document.getElementById('newEmpDepartment').value = '';
      document.getElementById('newEmpHireDate').value = '';
      document.getElementById('newEmpLeaveDate').value = '';
      document.getElementById('newEmpStatus').value = '在职';
      document.getElementById('newEmpPosition').value = '';
      document.getElementById('newEmpBank').value = '';
      document.getElementById('newEmpBankCard').value = '';
      document.getElementById('newEmpRemarks').value = '';
      
      showToast('员工添加成功');
      // 更新员工统计信息
      updateEmployeeStats();
    }

    // 员工数据导出
    function exportEmployees() {
      if (employees.length === 0) {
        showToast('员工列表为空，无法导出', true);
        return;
      }
      
      // 准备导出数据 - 映射为Excel列名
      const exportData = employees.map(emp => ({
        '工号': emp.id,
        '姓名': emp.name,
        '手机号': emp.phone,
        '身份证号': emp.idCard,
        '所属公司': emp.company,
        '职位': emp.position || '',
        '开户行': emp.bank || '',
        '卡号': emp.bankCard,
        '入职日期': emp.hireDate || '',
        '离职日期': emp.leaveDate || '',
        '备注': emp.remarks || ''
      }));
      
      // 创建工作簿和工作表
      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, '员工数据');
      
      // 生成并下载Excel文件
      const today = new Date().toISOString().split('T')[0];
      XLSX.writeFile(workbook, `员工数据_${today}.xlsx`);
      
      showToast('员工数据导出成功');
    }

    // 下载导入模板
    function downloadTemplate() {
      // 创建模板数据 - 包含表头和一条示例数据
      const templateData = [
        {
          '工号': 'EMP001',
          '姓名': '张三',
          '手机号': '13800138000',
          '身份证号': '310101********1234',
          '所属公司': '普利美常州',
          '职位': '工程师',
          '开户行': '招商银行',
          '卡号': '6225********1234',
          '入职日期': '2024-01-01',
          '离职日期': '',
          '备注': ''
        }
      ];
      
      // 创建工作簿和工作表
      const worksheet = XLSX.utils.json_to_sheet(templateData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, '员工模板');
      
      // 生成并下载模板文件
      XLSX.writeFile(workbook, '员工数据导入模板.xlsx');
      
      showToast('导入模板下载成功');
    }

    // 处理文件上传
    function handleFileUpload(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          // 解析Excel文件
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // 获取第一个工作表
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          
          // 转换为JSON
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // 处理导入数据
          processImportData(jsonData);
        } catch (error) {
          showImportResult(false, '文件解析错误，请确保上传的是有效的Excel文件');
          console.error('Excel解析错误:', error);
        }
      };
      
      reader.onerror = function() {
        showImportResult(false, '文件读取错误，请重试');
      };
      
      reader.readAsArrayBuffer(file);
    }

    // 处理导入的数据
    function processImportData(importData) {
      const importMode = document.querySelector('input[name="importMode"]:checked').value;
      const newEmployees = [];
      const warnings = [];
      let successCount = 0;
      let updateCount = 0;
      
      // 验证公司是否有效
      const validCompanies = ['普利美常州', '无锡龙力', '普利美劳务派遣'];
      
      importData.forEach((item, index) => {
        const rowNum = index + 2; // 行号从2开始（包含表头）
        
        // 验证必填字段
        if (!item['工号'] || !item['姓名'] || !item['手机号'] || !item['身份证号'] || !item['卡号'] || !item['所属公司']) {
          warnings.push(`第${rowNum}行：缺少必填字段（工号、姓名、手机号、身份证号、卡号、所属公司为必填）`);
          return;
        }
        
        // 验证公司是否有效
        let company = item['所属公司'].toString().trim();
        if (!validCompanies.includes(company)) {
          warnings.push(`第${rowNum}行：公司"${company}"无效，已自动设置为"普利美常州"`);
          company = '普利美常州';
        }
        
        // 标准化日期函数
        function normalizeDate(dateValue) {
          if (!dateValue) return '';
          
          // 如果已经是字符串格式的日期，尝试解析为Date对象
          let date;
          if (typeof dateValue === 'string') {
            // 尝试直接解析
            date = new Date(dateValue);
          } else {
            // Excel导入的日期可能是数字格式（从1900年1月1日开始的天数）
            date = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
          }
          
          // 验证是否为有效日期
          if (isNaN(date.getTime())) return dateValue.toString().trim();
          
          // 返回标准化的日期字符串格式
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
        
        // 创建员工对象
        const employee = {
          id: item['工号'].toString().trim(),
          name: item['姓名'].toString().trim(),
          phone: item['手机号'].toString().trim(),
          idCard: item['身份证号'].toString().trim(),
          company: company,
          position: item['职位'] ? item['职位'].toString().trim() : '',
          bank: item['开户行'] ? item['开户行'].toString().trim() : '',
          bankCard: item['卡号'].toString().trim(),
          // 添加入职日期和离职日期处理，并进行标准化
          hireDate: item.hasOwnProperty('入职日期') && item['入职日期'] ? normalizeDate(item['入职日期']) : '',
          leaveDate: item.hasOwnProperty('离职日期') && item['离职日期'] ? normalizeDate(item['离职日期']) : '',
          // 修复备注字段导入问题：即使备注为空也应该正确处理
          remarks: item.hasOwnProperty('备注') ? (item['备注'] ? item['备注'].toString().trim() : '') : ''
        };
        
        // 根据离职日期设置员工状态
        if (employee.leaveDate) {
          employee.status = '离职';
        } else {
          employee.status = '在职';
        }
        
        // 检查是否已存在该员工
        const existingIndex = employees.findIndex(emp => emp.id === employee.id);
        
        if (existingIndex >= 0) {
          // 已存在，根据导入模式处理
          if (importMode === 'merge') {
            // 合并模式 - 更新现有员工
            employees[existingIndex] = employee;
            updateCount++;
          } else {
            // 替换模式 - 先移除再添加
            employees.splice(existingIndex, 1);
            newEmployees.push(employee);
            successCount++;
          }
        } else {
          // 新员工
          newEmployees.push(employee);
          successCount++;
        }
      });
      
      // 添加新员工到员工列表
      employees = importMode === 'replace' ? newEmployees : [...employees, ...newEmployees];
      
      // 保存员工数据到本地存储
      localStorage.setItem('salary_employees', JSON.stringify(employees));
      
      // 刷新员工列表
      renderEmployeeList(getFilteredEmployees());
      
      // 显示导入结果
      const totalProcessed = successCount + updateCount;
      const message = `共处理 ${totalProcessed} 条数据，新增 ${successCount} 人，更新 ${updateCount} 人`;
      showImportResult(true, message, warnings);
    }

    // 显示导入结果
    function showImportResult(isSuccess, message, warnings = []) {
      // 重置结果显示
      importSuccess.classList.add('hidden');
      importError.classList.add('hidden');
      importWarnings.classList.add('hidden');
      importWarningList.innerHTML = '';
      
      // 显示相应结果
      if (isSuccess) {
        importSuccessMessage.textContent = message;
        importSuccess.classList.remove('hidden');
        
        // 显示警告（如果有）
        if (warnings.length > 0) {
          warnings.forEach(warning => {
            const li = document.createElement('li');
            li.textContent = warning;
            importWarningList.appendChild(li);
          });
          importWarnings.classList.remove('hidden');
        }
      } else {
        importErrorMessage.textContent = message;
        importError.classList.remove('hidden');
      }
      
      // 隐藏导入模态框，显示结果模态框
      employeeImportModal.classList.add('hidden');
      importResultModal.classList.remove('hidden');
    }

    // 初始化文件拖放区域
    function initFileDropArea() {
      // 点击区域触发文件选择
      fileDropArea.addEventListener('click', () => {
        fileInput.click();
      });
      
      // 拖放事件
      fileDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileDropArea.classList.add('border-primary', 'bg-blue-50');
      });
      
      fileDropArea.addEventListener('dragleave', () => {
        fileDropArea.classList.remove('border-primary', 'bg-blue-50');
      });
      
      fileDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileDropArea.classList.remove('border-primary', 'bg-blue-50');
        
        if (e.dataTransfer.files.length) {
          const file = e.dataTransfer.files[0];
          if (file.type.includes('excel') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            handleFileUpload(file);
          } else {
            showToast('请上传Excel格式的文件（.xlsx或.xls）', true);
          }
        }
      });
      
      // 文件选择事件
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
          const file = fileInput.files[0];
          handleFileUpload(file);
        }
      });
    }

    // 从本地存储加载数据
    function loadFromLocalStorage() {
      // 加载员工数据
      const savedEmployees = localStorage.getItem('salary_employees');
      if (savedEmployees) {
        try {
          employees = JSON.parse(savedEmployees);
        } catch (e) {
          console.error('加载员工数据失败:', e);
        }
      }
      
      // 加载工资表数据
      const savedSalaryStorage = localStorage.getItem('salaryStorage');
      if (savedSalaryStorage) {
        try {
          salaryStorage = JSON.parse(savedSalaryStorage);
        } catch (e) {
          console.error('加载工资表数据失败:', e);
        }
      }
    }

    // 保存工资汇总数据到localStorage
    function saveSummaryDataToStorage() {
      // 直接使用paginationState.allData保存所有数据，而不是从页面表格读取
      if (paginationState && paginationState.allData && paginationState.allData.length > 0) {
        localStorage.setItem('salarySummaryData', JSON.stringify(paginationState.allData));
      } else {
        // 如果paginationState未初始化，仍使用原有的表格读取方式作为备份
        const salarySummaryTableBody = document.getElementById('salarySummaryTableBody');
        const summaryData = [];
        const rows = salarySummaryTableBody.querySelectorAll('tr:not(.text-gray-500)');
        
        rows.forEach(row => {
          const yearMonthText = row.querySelector('td:nth-child(2)').textContent;
          const yearMatch = yearMonthText.match(/(\d+)年/);
          const monthMatch = yearMonthText.match(/年(\d+)月/);
          
          if (yearMatch && monthMatch) {
            // 对于incomeTax和remarks，需要检查是否为输入框
            const incomeTaxCell = row.querySelector('td:nth-child(18)');
            const incomeTaxInput = incomeTaxCell.querySelector('input');
            const incomeTax = incomeTaxInput ? parseFloat(incomeTaxInput.value) : parseFloat(incomeTaxCell.textContent);
            
            const remarksCell = row.querySelector('td:nth-child(20)');
            const remarksInput = remarksCell.querySelector('input');
            const remarks = remarksInput ? remarksInput.value : remarksCell.textContent;
            
            summaryData.push({
              year: parseInt(yearMatch[1]),
              month: parseInt(monthMatch[1]),
              employeeId: row.querySelector('td:nth-child(3)').textContent,
              name: row.querySelector('td:nth-child(4)').textContent,
              idCard: row.querySelector('td:nth-child(5)').textContent,
              phone: row.querySelector('td:nth-child(6)').textContent,
              bankCard: row.querySelector('td:nth-child(7)').textContent,
              company: row.querySelector('td:nth-child(8)').textContent,
              attendanceDays: parseFloat(row.querySelector('td:nth-child(9)').textContent),
              basicSalary: parseFloat(row.querySelector('td:nth-child(10)').textContent),
              performanceBonus: parseFloat(row.querySelector('td:nth-child(11)').textContent),
              housingAllowance: parseFloat(row.querySelector('td:nth-child(12)').textContent),
              otherAllowance: parseFloat(row.querySelector('td:nth-child(13)').textContent),
              yearEndBonus: parseFloat(row.querySelector('td:nth-child(14)').textContent),
              socialSecurity: parseFloat(row.querySelector('td:nth-child(15)').textContent),
              providentFund: parseFloat(row.querySelector('td:nth-child(16)').textContent),
              loanDeduction: parseFloat(row.querySelector('td:nth-child(17)').textContent),
              incomeTax: incomeTax,
              netSalary: parseFloat(row.querySelector('td:nth-child(19)').textContent),
              remarks: remarks
            });
          }
        });
        
        localStorage.setItem('salarySummaryData', JSON.stringify(summaryData));
      }
    }
    
    // 从localStorage加载工资汇总数据
    function loadSummaryDataFromStorage() {
      const salarySummaryTableBody = document.getElementById('salarySummaryTableBody');
      const storedData = localStorage.getItem('salarySummaryData');
      if (!storedData) return;
      
      const summaryData = JSON.parse(storedData);
      if (summaryData.length === 0) return;
      
      // 清空表格
      salarySummaryTableBody.innerHTML = '';
      
      // 按年份月份降序排序
      summaryData.sort((a, b) => {
        const keyA = a.year * 100 + a.month;
        const keyB = b.year * 100 + b.month;
        return keyB - keyA;
      });
      
      // 重建表格
      summaryData.forEach((data, index) => {
        const summaryRow = document.createElement('tr');
        const bgColorClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        summaryRow.className = `hover:bg-gray-50 ${bgColorClass}`;
        
        const yearMonth = `${data.year}年${data.month}月`;
        
        const cells = [
          `<td class="px-3 py-2 border border-gray-300 sticky left-0 ${bgColorClass} z-0">
            <input type="checkbox" class="summary-checkbox w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
          </td>`,
          `<td class="px-3 py-2 border border-gray-300 sticky left-[40px] ${bgColorClass} z-0">${yearMonth}</td>`,
          `<td class="px-3 py-2 border border-gray-300 sticky left-[120px] ${bgColorClass} z-0">${data.employeeId}</td>`,
          `<td class="px-3 py-2 border border-gray-300 sticky left-[200px] ${bgColorClass} z-0">${data.name}</td>`,
          `<td class="px-3 py-2 border border-gray-300">${data.idCard}</td>`,
          `<td class="px-3 py-2 border border-gray-300">${data.phone}</td>`,
          `<td class="px-3 py-2 border border-gray-300">${data.bankCard}</td>`,
          `<td class="px-3 py-2 border border-gray-300">${data.company}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.attendanceDays}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.basicSalary.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.performanceBonus.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.housingAllowance.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.otherAllowance.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.yearEndBonus.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.socialSecurity.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.providentFund.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.loanDeduction.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">
            <input type="number" min="0" step="0.01" value="${data.incomeTax.toFixed(2)}" 
                   class="w-full text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                   onchange="updateSummaryIncomeTax(this, '${data.id}', ${data.year}, ${data.month})">
          </td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right font-bold text-primary">${data.netSalary.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300">
            <input type="text" value="${data.remarks}" 
                   class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                   onchange="updateSummaryRemarks(this, '${data.id}', ${data.year}, ${data.month})"></td>`,
          `<td class="px-3 py-2 border border-gray-300 text-center">
            <button class="px-3 py-1 bg-blue-500 text-white rounded mr-2 hover:bg-blue-600 transition-colors" onclick="viewSalarySummary('${data.id}', ${data.year}, ${data.month})">查看</button>
            <button class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors" onclick="editSalarySummary('${data.id}', ${data.year}, ${data.month})">编辑</button>
          </td>`
        ];
        
        summaryRow.innerHTML = cells.join('');
        salarySummaryTableBody.appendChild(summaryRow);
      });
      
      // 调整文本大小
      if (typeof adjustSummaryTableTextSizes === 'function') {
        adjustSummaryTableTextSizes();
      }
      
      // 更新合计行
      if (typeof updateSummaryTotalRow === 'function') {
        updateSummaryTotalRow();
      }
      
      // 添加汇总表复选框事件监听器
      addSummaryTableCheckboxListeners();
    }
    
    // 保存到工资汇总功能
    function saveToSalarySummary() {
      const salarySummaryTableBody = document.getElementById('salarySummaryTableBody');
      // 获取当前选择的年月
      const year = parseInt(salaryYear.value);
      const month = parseInt(salaryMonth.value);
      const yearMonth = `${year}年${month}月`;
      
      // 获取工资表中的所有数据行
      const salaryRows = salaryTableBody.querySelectorAll('tr');
      
      if (salaryRows.length === 0) {
        showToast('工资表为空，无法保存到汇总', true);
        return;
      }
      
      // 检查是否有实发工资为0的员工
      let hasZeroNetSalary = false;
      salaryRows.forEach(row => {
        // 跳过可能的空行或表头
        if (!row.querySelector('input[data-id]')) return;
        
        // 从工资表行中获取工资数据用于计算实发工资
        const basicSalary = parseFloat(row.querySelector('td:nth-child(9) input')?.value || '0') || 0;
        const performanceBonus = parseFloat(row.querySelector('td:nth-child(10) input')?.value || '0') || 0;
        const housingAllowance = parseFloat(row.querySelector('td:nth-child(11) input')?.value || '0') || 0;
        const otherAllowance = parseFloat(row.querySelector('td:nth-child(12) input')?.value || '0') || 0;
        const yearEndBonus = parseFloat(row.querySelector('td:nth-child(13) input')?.value || '0') || 0;
        const socialSecurity = parseFloat(row.querySelector('td:nth-child(14) input')?.value || '0') || 0;
        const providentFund = parseFloat(row.querySelector('td:nth-child(15) input')?.value || '0') || 0;
        const loanDeduction = parseFloat(row.querySelector('td:nth-child(16) input')?.value || '0') || 0;
        const incomeTax = parseFloat(row.querySelector('td:nth-child(17) input')?.value || '0') || 0;
        
        // 计算实发工资
        const netSalary = basicSalary + performanceBonus + housingAllowance + otherAllowance + yearEndBonus - 
                         (socialSecurity + providentFund + loanDeduction + incomeTax);
        
        // 检查实发工资是否为0
        if (netSalary === 0) {
          hasZeroNetSalary = true;
        }
      });
      
      // 如果有实发工资为0的员工，拒绝保存并显示提示
      if (hasZeroNetSalary) {
        showToast('漏做员工工资，请检查', true);
        return;
      }
      
      // 收集所有汇总数据（包括现有数据和新数据）
      const allSummaryData = [];
      
      // 1. 首先收集现有的汇总数据
      const existingRows = salarySummaryTableBody.querySelectorAll('tr:not(.text-gray-500)'); // 排除空数据提示行
      existingRows.forEach(row => {
        const yearMonthText = row.querySelector('td:nth-child(2)').textContent;
        const yearMatch = yearMonthText.match(/(\d+)年/);
        const monthMatch = yearMonthText.match(/年(\d+)月/);
        
        if (yearMatch && monthMatch) {
          const rowYear = parseInt(yearMatch[1]);
          const rowMonth = parseInt(monthMatch[1]);
          
          // 保存行数据和排序键
          allSummaryData.push({
            row: row,
            year: rowYear,
            month: rowMonth,
            key: rowYear * 100 + rowMonth // 用于排序的键值
          });
        }
      });
      
      // 2. 收集新的工资数据
      const newRows = [];
      salaryRows.forEach(row => {
        // 跳过可能的空行或表头
        if (!row.querySelector('input[data-id]')) return;
        
        const employeeId = row.querySelector('input[data-id]').dataset.id;
        const employee = employees.find(emp => emp.id === employeeId);
        
        if (employee) {
          // 从工资表行中获取工资数据
          const attendanceDays = parseFloat(row.querySelector('td:nth-child(8) input')?.value || '22') || 22;
          const basicSalary = parseFloat(row.querySelector('td:nth-child(9) input')?.value || '0') || 0;
          const performanceBonus = parseFloat(row.querySelector('td:nth-child(10) input')?.value || '0') || 0;
          const housingAllowance = parseFloat(row.querySelector('td:nth-child(11) input')?.value || '0') || 0;
          const otherAllowance = parseFloat(row.querySelector('td:nth-child(12) input')?.value || '0') || 0;
          const yearEndBonus = parseFloat(row.querySelector('td:nth-child(13) input')?.value || '0') || 0;
          const socialSecurity = parseFloat(row.querySelector('td:nth-child(14) input')?.value || '0') || 0;
          const providentFund = parseFloat(row.querySelector('td:nth-child(15) input')?.value || '0') || 0;
          const loanDeduction = parseFloat(row.querySelector('td:nth-child(16) input')?.value || '0') || 0;
          const incomeTax = parseFloat(row.querySelector('td:nth-child(17) input')?.value || '0') || 0;
          
          // 计算实发工资
          const netSalary = basicSalary + performanceBonus + housingAllowance + otherAllowance + yearEndBonus - 
                           (socialSecurity + providentFund + loanDeduction + incomeTax);
          
          const remarks = row.querySelector('td:nth-child(19) input')?.value || '';
          
          // 创建汇总表格行
          const summaryRow = document.createElement('tr');
          const bgColorClass = newRows.length % 2 === 0 ? 'bg-white' : 'bg-gray-50';
          summaryRow.className = `hover:bg-gray-50 ${bgColorClass}`;
          
          // 创建单元格
          const cells = [
            // 复选框列
            `<td class="px-3 py-2 border border-gray-300 sticky left-0 ${bgColorClass} z-0">
              <input type="checkbox" class="summary-checkbox w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
            </td>`,
            // 年月列
            `<td class="px-3 py-2 border border-gray-300 sticky left-[40px] ${bgColorClass} z-0">${yearMonth}</td>`,
            // 工号列
            `<td class="px-3 py-2 border border-gray-300 sticky left-[120px] ${bgColorClass} z-0">${employee.id}</td>`,
            // 姓名列
            `<td class="px-3 py-2 border border-gray-300 sticky left-[200px] ${bgColorClass} z-0">${employee.name}</td>`,
            // 身份证号列
            `<td class="px-3 py-2 border border-gray-300">${employee.idCard}</td>`,
            // 手机号列
            `<td class="px-3 py-2 border border-gray-300">${employee.phone}</td>`,
            // 卡号列
            `<td class="px-3 py-2 border border-gray-300">${employee.bankCard}</td>`,
            // 所属公司列
            `<td class="px-3 py-2 border border-gray-300">${employee.company}</td>`,
            // 出勤天数列
            `<td class="px-3 py-2 border border-gray-300 text-right">${attendanceDays}</td>`,
            // 基本工资列
            `<td class="px-3 py-2 border border-gray-300 text-right">${basicSalary.toFixed(2)}</td>`,

            // 绩效奖列
            `<td class="px-3 py-2 border border-gray-300 text-right">${performanceBonus.toFixed(2)}</td>`,
            // 房贴列
            `<td class="px-3 py-2 border border-gray-300 text-right">${housingAllowance.toFixed(2)}</td>`,
            // 其它补贴列
            `<td class="px-3 py-2 border border-gray-300 text-right">${otherAllowance.toFixed(2)}</td>`,
            // 年终奖列
            `<td class="px-3 py-2 border border-gray-300 text-right">${yearEndBonus.toFixed(2)}</td>`,
            // 代扣个人社保列
            `<td class="px-3 py-2 border border-gray-300 text-right">${socialSecurity.toFixed(2)}</td>`,
            // 代扣公积金列
            `<td class="px-3 py-2 border border-gray-300 text-right">${providentFund.toFixed(2)}</td>`,
            // 扣借款列
            `<td class="px-3 py-2 border border-gray-300 text-right">${loanDeduction.toFixed(2)}</td>`,
            // 代扣个税列 - 可编辑输入框
            `<td class="px-3 py-2 border border-gray-300 text-right">
              <input type="number" min="0" step="0.01" value="${incomeTax.toFixed(2)}" 
                     class="w-full text-right px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                     onchange="updateSummaryIncomeTax(this, ${employee.id}, ${year}, ${month})">
            </td>`,
            // 实发工资列
            `<td class="px-3 py-2 border border-gray-300 text-right font-bold text-primary">${netSalary.toFixed(2)}</td>`,
            // 备注列 - 可编辑输入框
            `<td class="px-3 py-2 border border-gray-300">
              <input type="text" value="${remarks}" 
                     class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                     onchange="updateSummaryRemarks(this, ${employee.id}, ${year}, ${month})">
            </td>`
          ];
          
          // 设置行内容
          summaryRow.innerHTML = cells.join('');
          
          // 添加到新行数组
          newRows.push(summaryRow);
          
          // 同时添加到所有汇总数据中（用于排序）
          allSummaryData.push({
            row: summaryRow,
            year: year,
            month: month,
            key: year * 100 + month
          });
        }
      });
      
      // 对所有汇总数据按年份月份降序排序（最新的在前面）
      allSummaryData.sort((a, b) => b.key - a.key);
      
      // 清空并重新填充表格，保持排序顺序
      salarySummaryTableBody.innerHTML = '';
      allSummaryData.forEach(data => {
        salarySummaryTableBody.appendChild(data.row);
      });
      
      // 重要修复：更新paginationState.allData数组，确保所有数据都被保存
      // 首先从localStorage获取现有数据，如果没有则初始化为空数组
      let existingSummaryData = [];
      const storedData = localStorage.getItem('salarySummaryData');
      if (storedData) {
        existingSummaryData = JSON.parse(storedData);
      }
      
      // 为新添加的数据创建适合存储的数据结构
      const newDataToStore = [];
      salaryRows.forEach(row => {
        // 跳过可能的空行或表头
        if (!row.querySelector('input[data-id]')) return;
        
        const employeeId = row.querySelector('input[data-id]').dataset.id;
        const employee = employees.find(emp => emp.id === employeeId);
        
        if (employee) {
          // 从工资表行中获取工资数据
          const attendanceDays = parseFloat(row.querySelector('td:nth-child(8) input')?.value || '22') || 22;
          const basicSalary = parseFloat(row.querySelector('td:nth-child(9) input')?.value || '0') || 0;
          const performanceBonus = parseFloat(row.querySelector('td:nth-child(10) input')?.value || '0') || 0;
          const housingAllowance = parseFloat(row.querySelector('td:nth-child(11) input')?.value || '0') || 0;
          const otherAllowance = parseFloat(row.querySelector('td:nth-child(12) input')?.value || '0') || 0;
          const yearEndBonus = parseFloat(row.querySelector('td:nth-child(13) input')?.value || '0') || 0;
          const socialSecurity = parseFloat(row.querySelector('td:nth-child(14) input')?.value || '0') || 0;
          const providentFund = parseFloat(row.querySelector('td:nth-child(15) input')?.value || '0') || 0;
          const loanDeduction = parseFloat(row.querySelector('td:nth-child(16) input')?.value || '0') || 0;
          const incomeTax = parseFloat(row.querySelector('td:nth-child(17) input')?.value || '0') || 0;
          const remarks = row.querySelector('td:nth-child(19) input')?.value || '';
          
          // 计算实发工资
          const netSalary = basicSalary + performanceBonus + housingAllowance + otherAllowance + yearEndBonus - 
                           (socialSecurity + providentFund + loanDeduction + incomeTax);
          
          // 检查是否已存在相同员工、年份和月份的数据，如果存在则替换，不存在则添加
          const existingIndex = existingSummaryData.findIndex(item => 
            item.employeeId === employee.id && item.year === year && item.month === month
          );
          
          const newDataItem = {
            year: year,
            month: month,
            employeeId: employee.id,
            name: employee.name,
            idCard: employee.idCard,
            phone: employee.phone,
            bankCard: employee.bankCard,
            company: employee.company,
            attendanceDays: attendanceDays,
            basicSalary: basicSalary,
            performanceBonus: performanceBonus,
            housingAllowance: housingAllowance,
            otherAllowance: otherAllowance,
            yearEndBonus: yearEndBonus,
            socialSecurity: socialSecurity,
            providentFund: providentFund,
            loanDeduction: loanDeduction,
            incomeTax: incomeTax,
            netSalary: netSalary,
            remarks: remarks
          };
          
          if (existingIndex !== -1) {
            existingSummaryData[existingIndex] = newDataItem;
          } else {
            newDataToStore.push(newDataItem);
          }
        }
      });
      
      // 合并现有数据和新数据
      const updatedSummaryData = [...existingSummaryData, ...newDataToStore];
      
      // 按年份月份降序排序
      updatedSummaryData.sort((a, b) => {
        const keyA = a.year * 100 + a.month;
        const keyB = b.year * 100 + b.month;
        return keyB - keyA;
      });
      
      // 更新paginationState.allData，确保所有数据都被保存
      paginationState.allData = updatedSummaryData;
      
      showToast(`已成功保存${yearMonth}的工资数据到汇总`);
      
      // 如果汇总表格仍然为空，显示提示信息
      if (salarySummaryTableBody.children.length === 0) {
        salarySummaryTableBody.innerHTML = `
          <tr class="text-gray-500 text-center">
              <td colspan="22" class="px-3 py-8 border border-gray-300">
                <i class="fa fa-info-circle mr-2"></i>暂无汇总数据
              </td>
            </tr>
        `;
      } else {
        // 调整汇总表格中长文本字段的字体大小
        adjustSummaryTableTextSizes();
        
        // 更新合计行
        updateSummaryTotalRow();
        
        // 更新图表
        if (typeof drawSalaryChart === 'function') {
          const chartTimeRange = document.getElementById('chartTimeRange');
          const chartYearFilter = document.getElementById('chartYearFilter');
          if (chartTimeRange && chartYearFilter) {
            drawSalaryChart(chartTimeRange.value, chartYearFilter.value);
          }
        }
      }
      
      // 保存汇总数据到localStorage，确保页面刷新后数据不丢失
      saveSummaryDataToStorage();
  }
  
  // 更新工资汇总表格的合计行
  function updateSummaryTotalRow() {
    const summaryTable = document.getElementById('salarySummaryTable');
    const thead = summaryTable.querySelector('thead');
    
    // 移除已存在的合计行
    const existingTotalRow = summaryTable.querySelector('tr.summary-total-row');
    if (existingTotalRow) {
      existingTotalRow.remove();
    }
    
    // 获取所有数据行（排除空提示行和合计行）
    const dataRows = summaryTable.querySelectorAll('tbody tr:not(.text-gray-500):not(.summary-total-row)');
    
    if (dataRows.length === 0) {
      return; // 没有数据时不显示合计行
    }
    
    // 计算各数值列的合计
    const totals = {
      attendanceDays: 0,
      basicSalary: 0,
      performanceBonus: 0,
      housingAllowance: 0,
      otherAllowance: 0,
      yearEndBonus: 0,
      socialSecurity: 0,
      providentFund: 0,
      loanDeduction: 0,
      incomeTax: 0,
      netSalary: 0
    };
    
    dataRows.forEach(row => {
      // 从第9列开始是数值列
      totals.attendanceDays += parseFloat(row.querySelector('td:nth-child(9)').textContent || 0);
      totals.basicSalary += parseFloat(row.querySelector('td:nth-child(10)').textContent || 0);
      totals.performanceBonus += parseFloat(row.querySelector('td:nth-child(11)').textContent || 0);
      totals.housingAllowance += parseFloat(row.querySelector('td:nth-child(12)').textContent || 0);
      totals.otherAllowance += parseFloat(row.querySelector('td:nth-child(13)').textContent || 0);
      totals.yearEndBonus += parseFloat(row.querySelector('td:nth-child(14)').textContent || 0);
      totals.socialSecurity += parseFloat(row.querySelector('td:nth-child(15)').textContent || 0);
      totals.providentFund += parseFloat(row.querySelector('td:nth-child(16)').textContent || 0);
      totals.loanDeduction += parseFloat(row.querySelector('td:nth-child(17)').textContent || 0);
      
      // 个税可能是输入框
      const incomeTaxCell = row.querySelector('td:nth-child(18)');
      const incomeTaxInput = incomeTaxCell.querySelector('input');
      if (incomeTaxInput) {
        totals.incomeTax += parseFloat(incomeTaxInput.value || 0);
      } else {
        totals.incomeTax += parseFloat(incomeTaxCell.textContent || 0);
      }
      
      // 实发工资
      totals.netSalary += parseFloat(row.querySelector('td:nth-child(19)').textContent || 0);
    });
    
    // 创建合计行
    const totalRow = document.createElement('tr');
    totalRow.className = 'summary-total-row bg-gray-100 font-bold';
    
    totalRow.innerHTML = `
      <td colspan="8" class="px-3 py-2 border border-gray-300 text-center">合计</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${Math.round(totals.attendanceDays)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.basicSalary.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.performanceBonus.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.housingAllowance.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.otherAllowance.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.yearEndBonus.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.socialSecurity.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.providentFund.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.loanDeduction.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right">${totals.incomeTax.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300 text-right font-bold text-primary">${totals.netSalary.toFixed(2)}</td>
      <td class="px-3 py-2 border border-gray-300"></td>
      <td class="px-3 py-2 border border-gray-300"></td>
    `;
    
    // 在表头之前插入合计行
    summaryTable.insertBefore(totalRow, thead);
  }
  
  // 更新汇总表中的备注
  
  // 更新汇总表中的备注
    function updateSummaryRemarks(input, employeeId, year, month) {
      const newRemarks = input.value;
      // 更新localStorage中的备注数据
      updateSummaryDataInStorage(employeeId, year, month, 'remarks', newRemarks);
      
      // 更新合计行
      updateSummaryTotalRow();
      
      // 更新图表
      if (typeof drawSalaryChart === 'function') {
        const chartTimeRange = document.getElementById('chartTimeRange');
        const chartYearFilter = document.getElementById('chartYearFilter');
        if (chartTimeRange && chartYearFilter) {
          drawSalaryChart(chartTimeRange.value, chartYearFilter.value);
        }
      }
    }
  
  // 更新汇总表中的代扣个税并重新计算实发工资
  function updateSummaryIncomeTax(input, employeeId, year, month) {
    const newIncomeTax = parseFloat(input.value) || 0;
    const row = input.closest('tr');
    
    // 获取该行的所有相关薪资数据
    const basicSalary = parseFloat(row.querySelector('td:nth-child(10)').textContent);
    const performanceBonus = parseFloat(row.querySelector('td:nth-child(11)').textContent);
    const housingAllowance = parseFloat(row.querySelector('td:nth-child(12)').textContent);
    const otherAllowance = parseFloat(row.querySelector('td:nth-child(13)').textContent);
    const yearEndBonus = parseFloat(row.querySelector('td:nth-child(14)').textContent);
    const socialSecurity = parseFloat(row.querySelector('td:nth-child(15)').textContent);
    const providentFund = parseFloat(row.querySelector('td:nth-child(16)').textContent);
    const loanDeduction = parseFloat(row.querySelector('td:nth-child(17)').textContent);
    
    // 重新计算实发工资
    const grossSalary = basicSalary + performanceBonus + housingAllowance + otherAllowance + yearEndBonus;
    const totalDeductions = socialSecurity + providentFund + loanDeduction + newIncomeTax;
    const newNetSalary = grossSalary - totalDeductions;
    
    // 更新实发工资显示
    const netSalaryCell = row.querySelector('td:nth-child(19)');
    netSalaryCell.textContent = newNetSalary.toFixed(2);
    
    // 更新localStorage中的数据
    updateSummaryDataInStorage(employeeId, year, month, 'incomeTax', newIncomeTax, 'netSalary', newNetSalary);
    
    // 更新合计行
    updateSummaryTotalRow();
    
    // 更新图表
    if (typeof drawSalaryChart === 'function') {
      const chartTimeRange = document.getElementById('chartTimeRange');
      const chartYearFilter = document.getElementById('chartYearFilter');
      if (chartTimeRange && chartYearFilter) {
        drawSalaryChart(chartTimeRange.value, chartYearFilter.value);
      }
    }
  }
  
  // 更新localStorage中的汇总数据
    function updateSummaryDataInStorage(employeeId, year, month, field1, value1, field2, value2) {
      const storedData = localStorage.getItem('salarySummaryData');
      if (!storedData) return;
      
      const summaryData = JSON.parse(storedData);
      const index = summaryData.findIndex(item => 
        item.employeeId === employeeId && item.year === year && item.month === month
      );
    
    if (index !== -1) {
      summaryData[index][field1] = value1;
      if (field2 && value2 !== undefined) {
        summaryData[index][field2] = value2;
      }
      localStorage.setItem('salarySummaryData', JSON.stringify(summaryData));
    }
  }
    
    // 调整汇总表格中长文本字段的字体大小
    function adjustSummaryTableTextSizes() {
      // 使用setTimeout确保DOM完全渲染
      setTimeout(() => {
        // 调整身份证号、手机号、卡号等文本字段
        const textCells = document.querySelectorAll('#salarySummaryTableBody td:nth-child(5), #salarySummaryTableBody td:nth-child(6), #salarySummaryTableBody td:nth-child(7)');
        textCells.forEach(cell => {
          const text = cell.textContent.trim();
          if (text) {
            // 增加!important来确保样式优先级
            const style = document.createElement('style');
            style.textContent = `
              #salarySummaryTableBody td:nth-child(5),
              #salarySummaryTableBody td:nth-child(6),
              #salarySummaryTableBody td:nth-child(7) {
                font-size: 14px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
              }
            `;
            document.head.appendChild(style);
            
            // 调用增强版调整字体大小函数
            adjustFontSizeEnhanced(cell, text);
          }
        });
      }, 10);
    }
    
    // 增强版调整字体大小函数
    function adjustFontSizeEnhanced(element, text) {
      // 设置初始字体大小，带有!important
      element.style.fontSize = '14px !important';
      
      // 创建一个临时span元素来测量文本宽度
      const tempSpan = document.createElement('span');
      tempSpan.textContent = text;
      tempSpan.style.fontFamily = window.getComputedStyle(element).fontFamily;
      tempSpan.style.fontSize = '14px';
      tempSpan.style.position = 'absolute';
      tempSpan.style.visibility = 'hidden';
      tempSpan.style.whiteSpace = 'nowrap';
      tempSpan.style.padding = '2px';
      document.body.appendChild(tempSpan);
      
      // 获取元素可见宽度（减去内边距）
      const elementWidth = element.clientWidth - 10;
      const textWidth = tempSpan.offsetWidth;
      
      // 如果文本宽度超过元素宽度，缩小字体
      if (textWidth > elementWidth) {
        const scale = elementWidth / textWidth;
        const newSize = Math.max(6, 14 * scale); // 最小6px，进一步缩小
        // 使用CSS优先级更高的方法设置字体大小
        element.style.setProperty('font-size', `${newSize}px`, 'important');
      }
      
      // 移除临时元素
      document.body.removeChild(tempSpan);
    }
    
    // 初始化
    function init() {
      // 从本地存储加载数据
      loadFromLocalStorage();
      
      // 初始化日期选择器
      initDatePickers();
      
      // 加载当前年月的工资数据
      loadSalaryData(currentSalaryYear, currentSalaryMonth, true);
      
      // 历史记录区域已移除，不再渲染历史记录
      
      // 初始化员工列表
      renderEmployeeList(getFilteredEmployees());
      // 更新员工统计信息
      updateEmployeeStats();
      
      // 初始化文件拖放区域
      initFileDropArea();
      
      // 加载工资汇总数据
      loadSummaryDataFromStorage();
      
      // 获取保存到汇总按钮
      const saveToSummaryBtn = document.getElementById('saveToSummaryBtn');
      
      // 添加事件监听器
      employeeSearch.addEventListener('input', searchEmployees);
      companyFilter.addEventListener('change', searchEmployees);
      selectAllBtn.addEventListener('click', selectAllEmployees);
      deselectAllBtn.addEventListener('click', deselectAllEmployees);
      // 导出工资表按钮已移除，相关事件监听器已删除
      salaryTableSelectAll.addEventListener('change', toggleSalaryTableSelectAll);
      saveToSummaryBtn.addEventListener('click', saveToSalarySummary);
      
      // 渲染后添加工资表复选框事件监听器
      addSalaryTableCheckboxListeners();
      
      // 初始化汇总表复选框事件监听器
      setTimeout(() => {
        addSummaryTableCheckboxListeners();
      }, 100);
        
        // 清空工资汇总功能
        const clearSummaryBtn = document.getElementById('clearSummaryBtn');
        clearSummaryBtn.addEventListener('click', function() {
          if (confirm('确定要清空所有工资汇总记录吗？此操作不可恢复！')) {
            const salarySummaryTableBody = document.getElementById('salarySummaryTableBody');
            salarySummaryTableBody.innerHTML = `
              <tr class="text-gray-500 text-center">
                <td colspan="22" class="px-3 py-8 border border-gray-300">
                  <i class="fa fa-info-circle mr-2"></i>暂无汇总数据
                </td>
              </tr>
            `;
            localStorage.removeItem('salarySummaryData');
            showToast('工资汇总数据已清空');
          }
        });
      loadSalaryBtn.addEventListener('click', () => {
        const year = parseInt(salaryYear.value);
        const month = parseInt(salaryMonth.value);
        loadSalaryData(year, month);
      });
      
      // 添加新员工事件
      addEmployeeBtn.addEventListener('click', () => {
        // 清空工号输入框和公司选择
        document.getElementById('newEmpId').value = '';
        document.getElementById('newEmpCompany').value = '';
        
        // 显示模态框
        addEmployeeModal.classList.remove('hidden');
      });
      
      // 添加公司选择变化事件监听，自动生成对应公司的连续工号
      // 只绑定一次，避免重复绑定
      const companySelect = document.getElementById('newEmpCompany');
      if (!companySelect.hasAttribute('data-event-bound')) {
        companySelect.addEventListener('change', function() {
          generateNextCompanyId(this.value);
        });
        companySelect.setAttribute('data-event-bound', 'true');
      }
      
      // 根据选择的公司生成下一个连续工号
      function generateNextCompanyId(company) {
        if (!company) {
          document.getElementById('newEmpId').value = '';
          return;
        }
        
        // 筛选出该公司的所有员工
        const companyEmployees = employees.filter(emp => emp.company === company);
        
        if (companyEmployees.length === 0) {
          // 如果该公司还没有员工，从001开始
          document.getElementById('newEmpId').value = '001';
        } else {
          // 找出该公司中最大的工号并加1
          const maxId = Math.max(...companyEmployees.map(emp => parseInt(emp.id) || 0));
          document.getElementById('newEmpId').value = String(maxId + 1).padStart(3, '0');
        }
      }
      
      // 离职日期变化时自动更新状态
      document.getElementById('newEmpLeaveDate').addEventListener('change', function() {
        const statusInput = document.getElementById('newEmpStatus');
        if (this.value) {
          statusInput.value = '离职';
        } else {
          statusInput.value = '在职';
        }
      });
      
      closeAddEmployeeModal.addEventListener('click', () => addEmployeeModal.classList.add('hidden'));
      cancelAddEmployee.addEventListener('click', () => addEmployeeModal.classList.add('hidden'));
      confirmAddEmployee.addEventListener('click', addNewEmployee);
      
      // 员工导入导出事件
      employeeImportBtn.addEventListener('click', () => employeeImportModal.classList.remove('hidden'));
      employeeExportBtn.addEventListener('click', exportEmployees);
      closeEmployeeImportModal.addEventListener('click', () => employeeImportModal.classList.add('hidden'));
      cancelImport.addEventListener('click', () => employeeImportModal.classList.add('hidden'));
      confirmImport.addEventListener('click', () => {
        if (fileInput.files.length === 0) {
          showToast('请先选择要导入的文件', true);
          return;
        }
        handleFileUpload(fileInput.files[0]);
      });
      downloadTemplateBtn.addEventListener('click', downloadTemplate);
      closeImportResultModal.addEventListener('click', () => importResultModal.classList.add('hidden'));
      closeImportResult.addEventListener('click', () => importResultModal.classList.add('hidden'));
      
      // 确认加载事件
      closeConfirmLoadModal.addEventListener('click', () => confirmLoadModal.classList.add('hidden'));
      cancelLoad.addEventListener('click', () => confirmLoadModal.classList.add('hidden'));
      confirmLoad.addEventListener('click', () => {
        const year = parseInt(confirmLoad.dataset.targetYear);
        const month = parseInt(confirmLoad.dataset.targetMonth);
        loadSalaryData(year, month, true);
      });
      
      // 员工操作按钮事件监听
      const viewSelectedBtn = document.getElementById('viewSelectedBtn');
      const editSelectedBtn = document.getElementById('editSelectedBtn');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const clearSelectedBtn = document.getElementById('clearSelectedBtn');
      
      // 查看选中员工
      viewSelectedBtn.addEventListener('click', () => {
        const selectedEmployees = getSelectedEmployees();
        if (selectedEmployees.length === 0) {
          showToast('请先选择要查看的员工', true);
          return;
        }
        
        // 如果选择了多个员工，只显示第一个的详情
        const employee = selectedEmployees[0];
        showEmployeeDetails(employee, 'view');
      });
      
      // 编辑选中员工
      editSelectedBtn.addEventListener('click', () => {
        const selectedEmployees = getSelectedEmployees();
        if (selectedEmployees.length === 0) {
          showToast('请先选择要编辑的员工', true);
          return;
        }
        if (selectedEmployees.length > 1) {
          showToast('一次只能编辑一个员工', true);
          return;
        }
        
        const employee = selectedEmployees[0];
        showEmployeeDetails(employee, 'edit');
      });
      
      // 删除选中员工
      deleteSelectedBtn.addEventListener('click', () => {
        const selectedEmployees = getSelectedEmployees();
        if (selectedEmployees.length === 0) {
          showToast('请先选择要删除的员工', true);
          return;
        }
        
        if (confirm(`确定要删除选中的 ${selectedEmployees.length} 名员工吗？`)) {
          selectedEmployees.forEach(employee => {
            deleteEmployee(employee.id);
          });
          showToast(`成功删除 ${selectedEmployees.length} 名员工`);
          updateEmployeeList();
          updateSalaryTable();
          // 更新员工统计信息
          updateEmployeeStats();
        }
      });
      
      // 清空所有员工
      clearSelectedBtn.addEventListener('click', () => {
        if (employees.length === 0) {
          showToast('没有员工数据可清空');
          return;
        }
        
        if (confirm('确定要清空所有员工数据吗？此操作不可恢复！')) {
          // 清空员工数据数组
          employees = [];
          // 同时清空salaryData数组
          salaryData = [];
          // 保存到本地存储
          saveEmployeesToLocalStorage();
          // 重新渲染员工列表
          renderEmployeeList(getFilteredEmployees());
          // 重新加载工资数据
          loadSalaryData(currentSalaryYear, currentSalaryMonth);
          // 显示成功提示
          showToast('已成功清空所有员工数据');
          // 更新员工统计信息
          updateEmployeeStats();
        }
      });
      
      // 监听页面关闭事件，提示数据可能丢失
      window.addEventListener('beforeunload', (e) => {
        if (isDataModified) {
          e.preventDefault();
          e.returnValue = '您有修改的数据尚未处理，确定要离开吗？';
          return e.returnValue;
        }
      });
    }
    
    // 获取选中的员工
    function getSelectedEmployees() {
      const selectedIds = [];
      const checkboxes = document.querySelectorAll('#employeeList input[type="checkbox"]:checked');
      checkboxes.forEach(checkbox => {
        selectedIds.push(checkbox.dataset.id);
      });
      
      return employees.filter(emp => selectedIds.includes(emp.id));
    }
    
    // 显示员工详情
    function showEmployeeDetails(employee, mode) {
      // 创建并显示员工详情模态框
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.id = 'employeeDetailsModal';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'bg-white rounded-lg shadow-xl w-full max-w-2xl p-6';
      
      const modalHeader = document.createElement('div');
      modalHeader.className = 'flex justify-between items-center mb-4';
      
      const modalTitle = document.createElement('h3');
      modalTitle.className = 'text-xl font-bold text-gray-800';
      modalTitle.textContent = mode === 'view' ? `查看员工详情 - ${employee.name}` : `编辑员工信息 - ${employee.name}`;
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'text-gray-500 hover:text-gray-700';
      closeBtn.innerHTML = '<i class="fa fa-times text-xl"></i>';
      closeBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      modalHeader.appendChild(modalTitle);
      modalHeader.appendChild(closeBtn);
      
      const detailsGrid = document.createElement('div');
      detailsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6';
      
      // 创建详情字段
      const fields = [
        { label: '工号', value: employee.id, field: 'id' },
        { label: '姓名', value: employee.name, field: 'name' },
        { label: '手机号', value: employee.phone || '', field: 'phone' },
        { label: '身份证号', value: employee.idCard || '', field: 'idCard' },
        { label: '所属公司', value: employee.company || '', field: 'company' },
        { label: '所属部门', value: employee.department || '', field: 'department' },
        { label: '入职日期', value: employee.hireDate || '', field: 'hireDate' },
        { label: '离职日期', value: employee.leaveDate || '', field: 'leaveDate' },
        { label: '状态', value: employee.status || '在职', field: 'status' },
        { label: '职位', value: employee.position || '', field: 'position' },
        { label: '开户行', value: employee.bank || '', field: 'bank' },
        { label: '卡号', value: employee.bankCard || '', field: 'bankCard' }
      ];
      
      fields.forEach(field => {
        const fieldContainer = document.createElement('div');
        
        const fieldLabel = document.createElement('label');
        fieldLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
        fieldLabel.textContent = field.label;
        
        const fieldValue = document.createElement('div');
        
        if (mode === 'view') {
          fieldValue.className = 'w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-md';
          fieldValue.textContent = field.value || '-';
        } else {
          // 为不同类型的字段设置不同的输入类型
          const isDateField = field.field === 'hireDate' || field.field === 'leaveDate';
          const isStatusField = field.field === 'status';
          
          if (isDateField) {
            fieldValue.innerHTML = `
              <input type="date" id="editEmp${field.field.charAt(0).toUpperCase() + field.field.slice(1)}" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                     value="${field.value || ''}">
            `;
          } else if (isStatusField) {
            fieldValue.innerHTML = `
              <input type="text" id="editEmp${field.field.charAt(0).toUpperCase() + field.field.slice(1)}" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed"
                     value="${field.value || '在职'}" readonly>
            `;
          } else {
            fieldValue.innerHTML = `
              <input type="text" id="editEmp${field.field.charAt(0).toUpperCase() + field.field.slice(1)}" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                     value="${field.value || ''}" ${field.field === 'id' ? 'readonly' : ''}>
            `;
          }
        }
        
        fieldContainer.appendChild(fieldLabel);
        fieldContainer.appendChild(fieldValue);
        detailsGrid.appendChild(fieldContainer);
      });
      
      // 备注字段
      const remarkContainer = document.createElement('div');
      remarkContainer.className = 'md:col-span-2';
      
      const remarkLabel = document.createElement('label');
      remarkLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
      remarkLabel.textContent = '备注';
      
      const remarkValue = document.createElement('div');
      
      if (mode === 'view') {
        remarkValue.className = 'w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-md';
        remarkValue.textContent = employee.remarks || '-';
      } else {
        remarkValue.innerHTML = `
          <textarea id="editEmpRemarks" rows="2" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    ${employee.remarks || ''}
          </textarea>
        `;
      }
      
      remarkContainer.appendChild(remarkLabel);
      remarkContainer.appendChild(remarkValue);
      detailsGrid.appendChild(remarkContainer);
      
      const modalFooter = document.createElement('div');
      modalFooter.className = 'flex justify-end space-x-3';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors';
      cancelBtn.textContent = '关闭';
      cancelBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      modalFooter.appendChild(cancelBtn);
      
      if (mode === 'edit') {
        const saveBtn = document.createElement('button');
        saveBtn.className = 'px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors';
        saveBtn.textContent = '保存修改';
        saveBtn.addEventListener('click', () => {
          // 获取修改后的员工信息
          const updatedEmployee = {
            ...employee,
            name: document.getElementById('editEmpName').value,
            phone: document.getElementById('editEmpPhone').value,
            idCard: document.getElementById('editEmpIdCard').value,
            company: document.getElementById('editEmpCompany').value,
            department: document.getElementById('editEmpDepartment').value,
            hireDate: document.getElementById('editEmpHireDate').value,
            leaveDate: document.getElementById('editEmpLeaveDate').value,
            status: document.getElementById('editEmpStatus').value,
            position: document.getElementById('editEmpPosition').value,
            bank: document.getElementById('editEmpBank').value,
            bankCard: document.getElementById('editEmpBankCard').value,
            remarks: document.getElementById('editEmpRemarks').value
          };
          
          // 更新员工信息
          updateEmployee(updatedEmployee);
          showToast('员工信息更新成功');
          document.body.removeChild(modal);
          updateEmployeeList();
          updateSalaryTable();
          // 更新员工统计信息
          updateEmployeeStats();
        });
        
        modalFooter.appendChild(saveBtn);
      }
      
      modalContent.appendChild(modalHeader);
      modalContent.appendChild(detailsGrid);
      modalContent.appendChild(modalFooter);
      modal.appendChild(modalContent);
      
      document.body.appendChild(modal);
      
      // 为编辑模式添加离职日期变化时自动更新状态的功能
      if (mode === 'edit') {
        const leaveDateInput = document.getElementById('editEmpLeaveDate');
        const statusInput = document.getElementById('editEmpStatus');
        
        if (leaveDateInput && statusInput) {
          // 初始化状态（如果已有离职日期，状态应为离职）
          if (leaveDateInput.value) {
            statusInput.value = '离职';
          } else {
            statusInput.value = '在职';
          }
          
          // 添加change事件监听器
          leaveDateInput.addEventListener('change', function() {
            if (this.value) {
              statusInput.value = '离职';
            } else {
              statusInput.value = '在职';
            }
          });
        }
      }
    }
    
    // 删除员工函数
    function deleteEmployee(employeeId) {
      const index = employees.findIndex(emp => emp.id === employeeId);
      if (index !== -1) {
        employees.splice(index, 1);
        saveEmployeesToLocalStorage();
      }
    }
    
    // 更新员工信息
    function updateEmployee(updatedEmployee) {
      const index = employees.findIndex(emp => emp.id === updatedEmployee.id);
      if (index !== -1) {
        employees[index] = updatedEmployee;
        saveEmployeesToLocalStorage();
      }
    }

    // 保存员工数据到本地存储
    function saveEmployeesToLocalStorage() {
      localStorage.setItem('salary_employees', JSON.stringify(employees));
    }

    // 导出所有数据为JSON文件
    function exportAllDataToJson() {
      try {
        // 从localStorage获取所有相关数据
        const employeesData = localStorage.getItem('salary_employees') ? JSON.parse(localStorage.getItem('salary_employees')) : [];
        const salaryStorageData = localStorage.getItem('salaryStorage') ? JSON.parse(localStorage.getItem('salaryStorage')) : {};
        const salarySummaryData = localStorage.getItem('salarySummaryData') ? JSON.parse(localStorage.getItem('salarySummaryData')) : [];
        const todoListData = localStorage.getItem('todoList') ? JSON.parse(localStorage.getItem('todoList')) : [];
        
        // 组合所有数据到一个对象中
        const allData = {
          exportDate: new Date().toISOString(),
          employees: employeesData,
          salaryStorage: salaryStorageData,
          salarySummaryData: salarySummaryData,
          todoList: todoListData,
          // 导出所有localStorage数据作为完整备份
          allLocalStorageData: getAllLocalStorageData()
        };
        
        // 获取所有localStorage数据的辅助函数
        function getAllLocalStorageData() {
          const allData = {};
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            try {
              allData[key] = JSON.parse(localStorage.getItem(key));
            } catch (e) {
              // 如果某些数据不是有效的JSON，直接保存原始字符串
              allData[key] = localStorage.getItem(key);
            }
          }
          return allData;
        }
        
        // 创建Blob对象
        const jsonData = JSON.stringify(allData, null, 2); // 格式化JSON，便于阅读
        const blob = new Blob([jsonData], { type: 'application/json' });
        
        // 创建下载链接
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // 设置文件名，包含当前日期
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const filename = `工资管理数据_${year}${month}${day}.json`;
        
        // 设置下载属性
        a.href = url;
        a.download = filename;
        
        // 触发下载
        document.body.appendChild(a);
        a.click();
        
        // 清理
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
        
        // 显示成功提示
        showToast('数据已成功导出为JSON文件');
      } catch (error) {
        console.error('导出JSON文件失败:', error);
        showToast('导出失败，请稍后重试', true);
      }
    }
    
    // 导入JSON数据功能
    function importAllDataFromJson() {
      try {
        // 创建文件输入元素
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        
        // 监听文件选择事件
        fileInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (!file) {
            return;
          }
          
          // 验证文件类型
          if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
            showToast('请选择有效的JSON文件', true);
            return;
          }
          
          // 读取文件内容
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              // 解析JSON数据
              const importedData = JSON.parse(e.target.result);
              
              // 验证数据结构
              if (!importedData || typeof importedData !== 'object') {
                throw new Error('无效的数据格式');
              }
              
              // 保存数据到localStorage
              if (Array.isArray(importedData.employees)) {
                localStorage.setItem('salary_employees', JSON.stringify(importedData.employees));
              }
              if (typeof importedData.salaryStorage === 'object') {
                localStorage.setItem('salaryStorage', JSON.stringify(importedData.salaryStorage));
              }
              if (Array.isArray(importedData.salarySummaryData)) {
                localStorage.setItem('salarySummaryData', JSON.stringify(importedData.salarySummaryData));
              }
              if (Array.isArray(importedData.todoList)) {
                localStorage.setItem('todoList', JSON.stringify(importedData.todoList));
              }
              
              // 如果存在完整的localStorage数据备份，导入所有数据
              if (importedData.allLocalStorageData && typeof importedData.allLocalStorageData === 'object') {
                for (const [key, value] of Object.entries(importedData.allLocalStorageData)) {
                  try {
                    // 尝试将值作为JSON字符串存储
                    localStorage.setItem(key, JSON.stringify(value));
                  } catch (e) {
                    // 如果失败，尝试直接存储原始值
                    localStorage.setItem(key, value);
                  }
                }
              }
              
              // 显示成功提示
              showToast('数据已成功导入');
              
              // 重新加载页面以应用新数据
              setTimeout(() => {
                location.reload();
              }, 1500);
              
            } catch (parseError) {
              console.error('解析JSON文件失败:', parseError);
              showToast('JSON文件解析失败，请检查文件格式', true);
            }
          };
          
          reader.onerror = () => {
            showToast('文件读取失败，请稍后重试', true);
          };
          
          // 开始读取文件
          reader.readAsText(file);
        });
        
        // 触发文件选择对话框
        fileInput.click();
        
      } catch (error) {
        console.error('导入JSON文件失败:', error);
        showToast('导入失败，请稍后重试', true);
      }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      init();
      
      // 添加导出JSON按钮事件监听器
      const exportJsonBtn = document.getElementById('exportJsonBtn');
      if (exportJsonBtn) {
        exportJsonBtn.addEventListener('click', exportAllDataToJson);
      }
      
      // 添加导入JSON按钮事件监听器
      const importJsonBtn = document.getElementById('importJsonBtn');
      if (importJsonBtn) {
        importJsonBtn.addEventListener('click', importAllDataFromJson);
      }

      // 合并第三个DOMContentLoaded的初始化逻辑
      // 检查是否有汇总数据
      const storedData = localStorage.getItem('salarySummaryData');
      if (storedData) {
        try {
          const data = JSON.parse(storedData);
          if (data.length > 0) {
            paginationState.allData = data;
            applyPagination();
          }
        } catch (e) {
          console.error('解析汇总数据失败:', e);
        }
      }
      
      // 初始化图表 - 延迟执行
      setTimeout(() => {
        try {
          initSalaryChart();
        } catch (e) {
          console.warn('图表初始化跳过:', e.message);
        }
      }, 500);
      
      // 为状态筛选下拉框添加事件监听器
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', searchEmployees);
      }
      
      // 添加Excel文件导入事件监听
      if (excelFileInput) {
        excelFileInput.addEventListener('change', handleExcelImport);
      }
    });
  </script>
<!-- 生成工资明细表模态框 -->
  <div id="generateSalaryReportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">生成工资明细表</h3>
          <button id="closeGenerateSalaryReportModal" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <div class="grid grid-cols-1 gap-4 mb-6">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">选择年份 <span class="text-danger">*</span></label>
              <select id="reportYear" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                <!-- 年份选项将通过JS生成 -->
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">选择月份 <span class="text-danger">*</span></label>
              <select id="reportMonth" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                <!-- 月份选项将通过JS生成 -->
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">所属公司 <span class="text-danger">*</span></label>
            <select id="reportCompany" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
              <option value="普利美常州">普利美常州</option>
              <option value="无锡龙力">无锡龙力</option>
              <option value="普利美劳务派遣">普利美劳务派遣</option>
            </select>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button id="cancelGenerateReport" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
            取消
          </button>
          <button id="confirmGenerateReport" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
            生成报表
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 初始化生成工资明细表模态框
    document.addEventListener('DOMContentLoaded', function() {
      // 填充年份和月份选择器
      const reportYearSelect = document.getElementById('reportYear');
      const reportMonthSelect = document.getElementById('reportMonth');
      const currentYear = new Date().getFullYear();
      
      // 填充年份选项（2020年到2030年）
      for (let year = 2020; year <= 2030; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        reportYearSelect.appendChild(option);
      }
      
      // 填充月份选项
      for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month + '月';
        reportMonthSelect.appendChild(option);
      }
      
      // 设置当前年月为默认值
      reportYearSelect.value = currentYear;
      reportMonthSelect.value = new Date().getMonth() + 1;
      
      // 模态框控制
      const generateReportBtn = document.getElementById('generateSalaryReportBtn');
      const generateReportModal = document.getElementById('generateSalaryReportModal');
      const closeGenerateReportModal = document.getElementById('closeGenerateSalaryReportModal');
      const cancelGenerateReport = document.getElementById('cancelGenerateReport');
      const confirmGenerateReport = document.getElementById('confirmGenerateReport');
      
      // 打开模态框
      generateReportBtn.addEventListener('click', function() {
        generateReportModal.classList.remove('hidden');
      });
      
      // 关闭模态框函数
      function closeModal() {
        generateReportModal.classList.add('hidden');
      }
      
      // 关闭模态框事件
      closeGenerateReportModal.addEventListener('click', closeModal);
      cancelGenerateReport.addEventListener('click', closeModal);
      
      // 点击模态框外部关闭
      generateReportModal.addEventListener('click', function(e) {
        if (e.target === generateReportModal) {
          closeModal();
        }
      });
      
      // 确认生成报表
      confirmGenerateReport.addEventListener('click', function() {
        const year = reportYearSelect.value;
        const month = reportMonthSelect.value;
        const company = reportCompany.value;
        
        console.log('生成工资明细表：', { year, month, company });
        
        // 确保工资汇总数据已保存到localStorage
        try {
            // 获取当前的工资汇总数据
            let summaryData = [];
            const storedData = localStorage.getItem('salarySummaryData');
            if (storedData) {
                summaryData = JSON.parse(storedData);
            }
            
            // 重新保存数据，确保数据是最新的
            localStorage.setItem('salarySummaryData', JSON.stringify(summaryData));
            console.log('工资汇总数据已保存到localStorage');
        } catch (error) {
            console.error('保存工资汇总数据失败：', error);
        }
        
        // 在新窗口中打开工资明细表页面，保持工资管理页面不关闭
        window.open(`工资明细表.html?year=${year}&month=${month}&company=${encodeURIComponent(company)}`, '_blank');
        
        // 关闭模态框
        closeModal();
      });
    });
    
    // 工资汇总查询功能
    const searchSummaryBtn = document.getElementById('searchSummaryBtn');
    searchSummaryBtn.addEventListener('click', showSearchModal);
    
    // 显示查询模态框
    function showSearchModal() {
      // 创建模态框背景
      const modalBackdrop = document.createElement('div');
      modalBackdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
      modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) {
          document.body.removeChild(modalBackdrop);
        }
      });
      
      // 创建模态框内容
      const modal = document.createElement('div');
      modal.className = 'bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto';
      modal.addEventListener('click', (e) => e.stopPropagation());
      
      // 模态框头部
      const modalHeader = document.createElement('div');
      modalHeader.className = 'px-6 py-4 border-b border-gray-200 flex justify-between items-center';
      
      const modalTitle = document.createElement('h3');
      modalTitle.className = 'text-xl font-bold text-gray-800';
      modalTitle.textContent = '工资汇总查询';
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'text-gray-500 hover:text-gray-700';
      closeBtn.innerHTML = '<i class="fa fa-times text-xl"></i>';
      closeBtn.addEventListener('click', () => {
        document.body.removeChild(modalBackdrop);
      });
      
      modalHeader.appendChild(modalTitle);
      modalHeader.appendChild(closeBtn);
      
      // 模态框内容
      const modalBody = document.createElement('div');
      modalBody.className = 'px-6 py-4';
      
      // 查询条件表单
      const form = document.createElement('form');
      form.className = 'space-y-4';
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        performSearch();
      });
      
      // 公司筛选
      const companyFilterDiv = document.createElement('div');
      companyFilterDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
      
      const companyLabel = document.createElement('label');
      companyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
      companyLabel.textContent = '公司选择';
      
      const companySelect = document.createElement('select');
      companySelect.id = 'searchCompany';
      companySelect.className = 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent';
      
      const allCompaniesOption = document.createElement('option');
      allCompaniesOption.value = '';
      allCompaniesOption.textContent = '所有公司';
      
      const companySelectWrapper = document.createElement('div');
      companySelectWrapper.appendChild(companySelect);
      
      companyFilterDiv.appendChild(createFormField(companyLabel, companySelectWrapper));
      
      // 时间范围
      const timeFilterDiv = document.createElement('div');
      timeFilterDiv.className = 'grid grid-cols-2 gap-4';
      
      timeFilterDiv.appendChild(createTimeFilterField('开始年月', 'searchStartYear', 'searchStartMonth'));
      timeFilterDiv.appendChild(createTimeFilterField('结束年月', 'searchEndYear', 'searchEndMonth'));
      
      companyFilterDiv.appendChild(timeFilterDiv);
      form.appendChild(companyFilterDiv);
      
      // 员工筛选和关键词搜索（同一行）
      const searchFieldsDiv = document.createElement('div');
      searchFieldsDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
      
      const employeeNameInput = createInputField('员工姓名', 'searchEmployeeName', 'text', '输入员工姓名进行搜索');
      const employeeIdInput = createInputField('工号', 'searchEmployeeId', 'text', '输入工号进行搜索');
      const keywordInput = createInputField('关键词搜索（支持所有字段）', 'searchKeyword', 'text', '输入关键词进行搜索');
      
      searchFieldsDiv.appendChild(employeeNameInput);
      searchFieldsDiv.appendChild(employeeIdInput);
      searchFieldsDiv.appendChild(keywordInput);
      form.appendChild(searchFieldsDiv);
      
      // 搜索按钮
      const searchBtnWrapper = document.createElement('div');
      searchBtnWrapper.className = 'flex justify-end gap-3 pt-4';
      
      const resetBtn = document.createElement('button');
      resetBtn.type = 'button';
      resetBtn.className = 'px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50';
      resetBtn.textContent = '重置';
      resetBtn.addEventListener('click', resetSearchForm);
      
      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600';
      submitBtn.textContent = '查询';
      
      searchBtnWrapper.appendChild(resetBtn);
      searchBtnWrapper.appendChild(submitBtn);
      form.appendChild(searchBtnWrapper);
      
      modalBody.appendChild(form);
      
      // 搜索结果区域
      const resultDiv = document.createElement('div');
      resultDiv.id = 'searchResultContainer';
      resultDiv.className = 'mt-6 hidden';
      
      const resultHeader = document.createElement('div');
      resultHeader.className = 'flex justify-between items-center mb-3';
      
      const resultTitle = document.createElement('h4');
      resultTitle.className = 'font-semibold text-gray-800';
      resultTitle.textContent = '搜索结果';
      
      const buttonGroup = document.createElement('div');
      buttonGroup.className = 'flex gap-3';
      
      const downloadBtn = document.createElement('button');
      downloadBtn.id = 'downloadResultBtn';
      downloadBtn.className = 'px-3 py-1 bg-green-500 text-white rounded text-sm flex items-center';
      downloadBtn.innerHTML = '<i class="fa fa-download mr-1"></i> 下载Excel';
      downloadBtn.addEventListener('click', downloadSearchResults);
      
      const viewAllBtn = document.createElement('button');
      viewAllBtn.className = 'text-blue-500 hover:text-blue-700 text-sm';
      viewAllBtn.textContent = '查看全部';
      viewAllBtn.addEventListener('click', () => {
        document.body.removeChild(modalBackdrop);
        loadSummaryDataFromStorage();
      });
      
      buttonGroup.appendChild(downloadBtn);
      buttonGroup.appendChild(viewAllBtn);
      
      resultHeader.appendChild(resultTitle);
      resultHeader.appendChild(buttonGroup);
      
      const resultTableWrapper = document.createElement('div');
      resultTableWrapper.className = 'overflow-x-auto';
      
      const resultTable = document.createElement('table');
      resultTable.className = 'w-full border-collapse';
      
      const resultThead = document.createElement('thead');
      resultThead.innerHTML = `
        <tr class="bg-gray-100">
          <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">年/月</th>
          <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">姓名</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">出勤天数</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">基本工资</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">绩效奖</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">房贴</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">其它补贴</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">年终奖</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">代扣个人社保</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">代扣公积金</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">扣借款</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">代扣个税</th>
          <th class="px-3 py-2 border border-gray-300 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">实发工资</th>
          <th class="px-3 py-2 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">备注</th>
          <th class="px-3 py-2 border border-gray-300 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">操作</th>
        </tr>
      `;
      
      const resultTbody = document.createElement('tbody');
      resultTbody.id = 'searchResultTableBody';
      
      const resultTotalRow = document.createElement('tr');
      resultTotalRow.id = 'searchResultTotalRow';
      resultTotalRow.className = 'bg-gray-50 font-bold';
      
      resultTable.appendChild(resultThead);
      resultTable.appendChild(resultTbody);
      resultTable.appendChild(resultTotalRow);
      resultTableWrapper.appendChild(resultTable);
      
      resultDiv.appendChild(resultHeader);
      resultDiv.appendChild(resultTableWrapper);
      modalBody.appendChild(resultDiv);
      
      // 组装模态框
      modal.appendChild(modalHeader);
      modal.appendChild(modalBody);
      modalBackdrop.appendChild(modal);
      document.body.appendChild(modalBackdrop);
      
      // 初始化公司选项
      companySelect.appendChild(allCompaniesOption);
      // 获取所有公司
      const storedData = localStorage.getItem('salarySummaryData');
      const summaryData = storedData ? JSON.parse(storedData) : [];
      const uniqueCompanies = [...new Set(summaryData.map(item => item.company).filter(Boolean))];
      uniqueCompanies.forEach(company => {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        companySelect.appendChild(option);
      });
      
      // 初始化时间选择器
      initTimeSelectors();
    }
    
    // 创建表单字段
    function createFormField(label, inputElement) {
      const div = document.createElement('div');
      div.appendChild(label);
      div.appendChild(inputElement);
      return div;
    }
    
    // 创建输入字段
    function createInputField(labelText, id, type, placeholder) {
      const div = document.createElement('div');
      
      const label = document.createElement('label');
      label.htmlFor = id;
      label.className = 'block text-sm font-medium text-gray-700 mb-1';
      label.textContent = labelText;
      
      const input = document.createElement('input');
      input.type = type;
      input.id = id;
      input.placeholder = placeholder;
      input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent';
      
      div.appendChild(label);
      div.appendChild(input);
      return div;
    }
    
    // 创建时间筛选字段
    function createTimeFilterField(labelText, yearId, monthId) {
      const div = document.createElement('div');
      
      const label = document.createElement('label');
      label.className = 'block text-sm font-medium text-gray-700 mb-1';
      label.textContent = labelText;
      
      const flexDiv = document.createElement('div');
      flexDiv.className = 'flex gap-2';
      
      const yearSelect = document.createElement('select');
      yearSelect.id = yearId;
      yearSelect.className = 'flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent';
      
      const monthSelect = document.createElement('select');
      monthSelect.id = monthId;
      monthSelect.className = 'flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent';
      
      flexDiv.appendChild(yearSelect);
      flexDiv.appendChild(monthSelect);
      
      div.appendChild(label);
      div.appendChild(flexDiv);
      return div;
    }
    
    // 初始化时间选择器
    function initTimeSelectors() {
      const now = new Date();
      const currentYear = now.getFullYear();
      
      // 初始化年份选择器
      const yearSelectors = [
        document.getElementById('searchStartYear'),
        document.getElementById('searchEndYear')
      ];
      
      yearSelectors.forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">选择年份</option>';
          for (let year = 2020; year <= 2030; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + '年';
            select.appendChild(option);
          }
        }
      });
      
      // 初始化月份选择器
      const monthSelectors = [
        document.getElementById('searchStartMonth'),
        document.getElementById('searchEndMonth')
      ];
      
      monthSelectors.forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">选择月份</option>';
          for (let month = 1; month <= 12; month++) {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month + '月';
            select.appendChild(option);
          }
        }
      });
      
      // 设置默认年月为2025年12月
      const startYearSelect = document.getElementById('searchStartYear');
      const startMonthSelect = document.getElementById('searchStartMonth');
      const endYearSelect = document.getElementById('searchEndYear');
      const endMonthSelect = document.getElementById('searchEndMonth');
      
      if (startYearSelect) startYearSelect.value = '2025';
      if (startMonthSelect) startMonthSelect.value = '12';
      if (endYearSelect) endYearSelect.value = '2025';
      if (endMonthSelect) endMonthSelect.value = '12';
    }
    
    // 重置搜索表单
    function resetSearchForm() {
      document.getElementById('searchCompany').value = '';
      document.getElementById('searchStartYear').value = '';
      document.getElementById('searchStartMonth').value = '';
      document.getElementById('searchEndYear').value = '';
      document.getElementById('searchEndMonth').value = '';
      document.getElementById('searchEmployeeName').value = '';
      document.getElementById('searchEmployeeId').value = '';
      document.getElementById('searchKeyword').value = '';
      
      // 隐藏结果区域
      document.getElementById('searchResultContainer').classList.add('hidden');
    }
    
    // 执行搜索
    function performSearch() {
      // 获取搜索条件
      const company = document.getElementById('searchCompany').value;
      const startYear = document.getElementById('searchStartYear').value;
      const startMonth = document.getElementById('searchStartMonth').value;
      const endYear = document.getElementById('searchEndYear').value;
      const endMonth = document.getElementById('searchEndMonth').value;
      const employeeName = document.getElementById('searchEmployeeName').value.trim().toLowerCase();
      const employeeId = document.getElementById('searchEmployeeId').value.trim().toLowerCase();
      const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
      
      // 获取所有汇总数据
      const storedData = localStorage.getItem('salarySummaryData');
      const summaryData = storedData ? JSON.parse(storedData) : [];
      
      // 筛选数据
      let filteredData = summaryData.filter(item => {
        // 公司筛选
        if (company && item.company !== company) return false;
        
        // 时间范围筛选
        const itemYearMonth = item.year * 100 + item.month;
        if (startYear && startMonth) {
          const startYearMonth = parseInt(startYear) * 100 + parseInt(startMonth);
          if (itemYearMonth < startYearMonth) return false;
        }
        if (endYear && endMonth) {
          const endYearMonth = parseInt(endYear) * 100 + parseInt(endMonth);
          if (itemYearMonth > endYearMonth) return false;
        }
        
        // 员工筛选
        if (employeeName && !item.name.toLowerCase().includes(employeeName)) return false;
        if (employeeId && !item.employeeId.toLowerCase().includes(employeeId)) return false;
        
        // 关键词搜索（搜索所有字段）
        if (keyword) {
          const keywordLower = keyword.toLowerCase();
          return Object.values(item).some(value => {
            if (value === null || value === undefined) return false;
            return String(value).toLowerCase().includes(keywordLower);
          });
        }
        
        return true;
      });
      
      // 显示搜索结果
      displaySearchResults(filteredData);
    }
    
    // 显示搜索结果
      function displaySearchResults(data) {
        const resultContainer = document.getElementById('searchResultContainer');
        const resultTableBody = document.getElementById('searchResultTableBody');
        const resultTotalRow = document.getElementById('searchResultTotalRow');
        const downloadBtn = document.getElementById('downloadResultBtn');
        
        // 清空表格
        resultTableBody.innerHTML = '';
        
        if (data.length === 0) {
          // 显示无结果提示
          const noResultRow = document.createElement('tr');
          noResultRow.className = 'text-gray-500 text-center';
          noResultRow.innerHTML = `
            <td colspan="15" class="px-3 py-4 border border-gray-300 whitespace-nowrap">
              <i class="fa fa-info-circle mr-2"></i>未找到匹配的数据
            </td>
          `;
          resultTableBody.appendChild(noResultRow);
          
          // 清空合计行
          resultTotalRow.innerHTML = '<td colspan="14" class="px-3 py-2 border border-gray-300"></td>';
          
          // 禁用下载按钮
          downloadBtn.disabled = true;
          downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          // 启用下载按钮
          downloadBtn.disabled = false;
          downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          
          // 存储当前搜索结果用于下载
          window.currentSearchResults = data;
        // 计算合计
        const totals = {
          attendanceDays: 0,
          basicSalary: 0,
          performanceBonus: 0,
          housingAllowance: 0,
          otherAllowance: 0,
          yearEndBonus: 0,
          socialSecurity: 0,
          providentFund: 0,
          loanDeduction: 0,
          incomeTax: 0,
          netSalary: 0
        };
        
        // 添加数据行
        data.forEach(item => {
          totals.attendanceDays += item.attendanceDays || 0;
          totals.basicSalary += item.basicSalary || 0;
          totals.performanceBonus += item.performanceBonus || 0;
          totals.housingAllowance += item.housingAllowance || 0;
          totals.otherAllowance += item.otherAllowance || 0;
          totals.yearEndBonus += item.yearEndBonus || 0;
          totals.socialSecurity += item.socialSecurity || 0;
          totals.providentFund += item.providentFund || 0;
          totals.loanDeduction += item.loanDeduction || 0;
          totals.incomeTax += item.incomeTax || 0;
          totals.netSalary += item.netSalary || 0;
          
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-3 py-2 border border-gray-300 whitespace-nowrap">${item.year}年${item.month}月</td>
            <td class="px-3 py-2 border border-gray-300 whitespace-nowrap sticky left-0 bg-white z-10">${item.name}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${item.attendanceDays}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.basicSalary || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.performanceBonus || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.housingAllowance || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.otherAllowance || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.yearEndBonus || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.socialSecurity || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.providentFund || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.loanDeduction || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${(item.incomeTax || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 text-right font-bold text-primary whitespace-nowrap">${(item.netSalary || 0).toFixed(2)}</td>
            <td class="px-3 py-2 border border-gray-300 whitespace-nowrap">${item.remarks || ''}</td>
            <td class="px-3 py-2 border border-gray-300 whitespace-nowrap text-center">
              <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="viewSalarySummary('${item.employeeId}', ${item.year}, ${item.month})"><i class="fa fa-eye mr-1"></i>查看</button>
              <button class="text-green-500 hover:text-green-700" onclick="editSalarySummary('${item.employeeId}', ${item.year}, ${item.month})"><i class="fa fa-edit mr-1"></i>编辑</button>
            </td>
          `;
          resultTableBody.appendChild(row);
        });
        
        // 更新合计行
        resultTotalRow.innerHTML = `
          <td colspan="2" class="px-3 py-2 border border-gray-300 text-center whitespace-nowrap">合计</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${Math.round(totals.attendanceDays)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.basicSalary.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.performanceBonus.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.housingAllowance.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.otherAllowance.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.yearEndBonus.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.socialSecurity.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.providentFund.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.loanDeduction.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right whitespace-nowrap">${totals.incomeTax.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 text-right font-bold text-primary whitespace-nowrap">${totals.netSalary.toFixed(2)}</td>
          <td class="px-3 py-2 border border-gray-300 whitespace-nowrap"></td>
          <td class="px-3 py-2 border border-gray-300 whitespace-nowrap"></td>
        `;
      }
      
      // 显示结果区域
      resultContainer.classList.remove('hidden');
      
      // 滚动到结果区域
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      
      // 下载搜索结果为Excel文件
      function downloadSearchResults() {
        if (!window.currentSearchResults || window.currentSearchResults.length === 0) {
          alert('没有可下载的数据');
          return;
        }
        
        // 准备Excel数据
        const excelData = window.currentSearchResults.map(item => ({
          '年/月': `${item.year}年${item.month}月`,
          '姓名': item.name || '',
          '出勤天数': item.attendanceDays || 0,
          '基本工资': (item.basicSalary || 0).toFixed(2),
          '绩效奖': (item.performanceBonus || 0).toFixed(2),
          '房贴': (item.housingAllowance || 0).toFixed(2),
          '其它补贴': (item.otherAllowance || 0).toFixed(2),
          '年终奖': (item.yearEndBonus || 0).toFixed(2),
          '代扣个人社保': (item.socialSecurity || 0).toFixed(2),
          '代扣公积金': (item.providentFund || 0).toFixed(2),
          '扣借款': (item.loanDeduction || 0).toFixed(2),
          '代扣个税': (item.incomeTax || 0).toFixed(2),
          '实发工资': (item.netSalary || 0).toFixed(2),
          '备注': item.remarks || ''
        }));
        
        // 创建Excel工作表和工作簿
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, '工资汇总查询');
        
        // 设置文件名
        const now = new Date();
        const fileName = `工资汇总查询_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.xlsx`;
        
        // 下载Excel文件
        XLSX.writeFile(workbook, fileName);
      }
    
    // 分页相关变量
    let paginationState = {
      currentPage: 1,
      pageSize: 10,
      totalItems: 0,
      allData: []
    };
    
    // 重写loadSummaryDataFromStorage函数以支持分页
    const originalLoadSummaryData = loadSummaryDataFromStorage;
    loadSummaryDataFromStorage = function() {
      const salarySummaryTableBody = document.getElementById('salarySummaryTableBody');
      const storedData = localStorage.getItem('salarySummaryData');
      
      if (!storedData) {
        updatePaginationDisplay([]);
        return;
      }
      
      const summaryData = JSON.parse(storedData);
      
      // 按年份月份降序排序
      summaryData.sort((a, b) => {
        const keyA = a.year * 100 + a.month;
        const keyB = b.year * 100 + b.month;
        return keyB - keyA;
      });
      
      // 更新分页状态
      paginationState.allData = summaryData;
      paginationState.currentPage = 1;
      
      // 应用分页并显示数据
      applyPagination();
    };
    
    // 更新备注信息
    function updateRemarks(inputElement, employeeId, year, month) {
      const remarks = inputElement.value.trim();
      const storedData = localStorage.getItem('salarySummaryData');
      
      if (storedData) {
        const summaryData = JSON.parse(storedData);
        const targetIndex = summaryData.findIndex(item => 
          item.employeeId === employeeId && item.year === year && item.month === month
        );
        
        if (targetIndex !== -1) {
          summaryData[targetIndex].remarks = remarks;
          localStorage.setItem('salarySummaryData', JSON.stringify(summaryData));
          
          // 更新分页数据
          paginationState.allData = summaryData;
          
          // 显示保存成功提示
          const originalBg = inputElement.style.backgroundColor;
          inputElement.style.backgroundColor = '#d1fae5';
          setTimeout(() => {
            inputElement.style.backgroundColor = originalBg;
          }, 1000);
        }
      }
    };
    
    // 应用分页并显示数据
    function applyPagination() {
      const salarySummaryTableBody = document.getElementById('salarySummaryTableBody');
      const { allData, currentPage, pageSize } = paginationState;
      
      // 清空表格
      salarySummaryTableBody.innerHTML = '';
      
      if (allData.length === 0) {
        // 显示无数据提示
        salarySummaryTableBody.innerHTML = `
          <tr class="text-gray-500 text-center">
              <td colspan="22" class="px-3 py-8 border border-gray-300">
                <i class="fa fa-info-circle mr-2"></i>暂无汇总数据
              </td>
            </tr>
        `;
        updatePaginationDisplay([]);
        return;
      }
      
      // 计算分页数据
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const paginatedData = allData.slice(startIndex, endIndex);
      
      // 重建表格
      paginatedData.forEach((data, index) => {
        const summaryRow = document.createElement('tr');
        const bgColorClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        summaryRow.className = `hover:bg-gray-50 ${bgColorClass}`;
        
        const yearMonth = `${data.year}年${data.month}月`;
        
        const cells = [
          `<td class="px-3 py-2 border border-gray-300 sticky left-0 ${bgColorClass} z-0">
            <input type="checkbox" class="summary-checkbox w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
          </td>`,
          `<td class="px-3 py-2 border border-gray-300 sticky left-[40px] ${bgColorClass} z-0">${yearMonth}</td>`,
          `<td class="px-3 py-2 border border-gray-300 sticky left-[120px] ${bgColorClass} z-0">${data.employeeId}</td>`,
          `<td class="px-3 py-2 border border-gray-300 sticky left-[200px] ${bgColorClass} z-0">${data.name}</td>`,
          `<td class="px-3 py-2 border border-gray-300">${data.idCard}</td>`,
          `<td class="px-3 py-2 border border-gray-300">${data.phone}</td>`,
          `<td class="px-3 py-2 border border-gray-300">${data.bankCard}</td>`,
          `<td class="px-3 py-2 border border-gray-300">${data.company}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.attendanceDays}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.basicSalary.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.performanceBonus.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.housingAllowance.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.otherAllowance.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.yearEndBonus.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.socialSecurity.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.providentFund.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">${data.loanDeduction.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right">
            <input type="number" value="${data.incomeTax.toFixed(2)}" step="0.01" min="0" 
                   class="w-20 text-right border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-primary"
                   onchange="updateIncomeTax(this, '${data.employeeId}', ${data.year}, ${data.month})"></td>`,
          `<td class="px-3 py-2 border border-gray-300 text-right font-bold">${data.netSalary.toFixed(2)}</td>`,
          `<td class="px-3 py-2 border border-gray-300">
            <input type="text" value="${data.remarks || ''}"
                   class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-primary"
                   onchange="updateRemarks(this, '${data.employeeId}', ${data.year}, ${data.month})"></td>`,
          `<td class="px-3 py-2 border border-gray-300">
            <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="viewSalarySummary('${data.employeeId}', ${data.year}, ${data.month})"><i class="fa fa-eye mr-1"></i>查看</button>
            <button class="text-green-500 hover:text-green-700" onclick="editSalarySummary('${data.employeeId}', ${data.year}, ${data.month})"><i class="fa fa-edit mr-1"></i>编辑</button>
          </td>`
        ];
        
        summaryRow.innerHTML = cells.join('');
        salarySummaryTableBody.appendChild(summaryRow);
      });
      
      // 调整汇总表格中长文本字段的字体大小
      adjustSummaryTableTextSizes();
      
      // 更新分页显示
      updatePaginationDisplay(allData);
    }
    
    // 更新分页显示
    function updatePaginationDisplay(data) {
      const totalRecords = data.length;
      const totalRecordsEl = document.getElementById('totalRecords');
      const paginationControls = document.getElementById('paginationControls');
      const startRecordEl = document.getElementById('startRecord');
      const endRecordEl = document.getElementById('endRecord');
      const paginationTotalEl = document.getElementById('paginationTotal');
      const currentPageEl = document.getElementById('currentPage');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      
      // 更新统计信息
      totalRecordsEl.textContent = totalRecords;
      
      if (totalRecords > 0) {
        // 显示分页控件
        paginationControls.classList.remove('hidden');
        
        // 更新分页信息
        const { currentPage, pageSize } = paginationState;
        const totalPages = Math.ceil(totalRecords / pageSize);
        const startRecord = (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, totalRecords);
        
        startRecordEl.textContent = startRecord;
        endRecordEl.textContent = endRecord;
        paginationTotalEl.textContent = totalRecords;
        currentPageEl.textContent = currentPage;
        
        // 更新按钮状态
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage >= totalPages;
      } else {
        // 隐藏分页控件
        paginationControls.classList.add('hidden');
      }
      
      // 更新合计行（仅计算当前页的数据）
      updateSummaryTotalRow();
    }
    
    // 初始化分页控件事件监听
    function initPaginationEvents() {
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const pageSizeSelect = document.getElementById('pageSizeSelect');
      
      if (prevPageBtn) {
        prevPageBtn.addEventListener('click', () => {
          if (paginationState.currentPage > 1) {
            paginationState.currentPage--;
            applyPagination();
          }
        });
      }
      
      if (nextPageBtn) {
        nextPageBtn.addEventListener('click', () => {
          const totalPages = Math.ceil(paginationState.allData.length / paginationState.pageSize);
          if (paginationState.currentPage < totalPages) {
            paginationState.currentPage++;
            applyPagination();
          }
        });
      }
      
      if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', () => {
          paginationState.pageSize = parseInt(pageSizeSelect.value);
          paginationState.currentPage = 1;
          applyPagination();
        });
      }
    }
    
    // 监听localStorage变化，更新分页显示
    window.addEventListener('storage', (e) => {
      if (e.key === 'salarySummaryData') {
        loadSummaryDataFromStorage();
      }
    });
    
    // 重写保存数据的函数，确保分页更新
    const originalSaveSummaryDataToStorage = saveSummaryDataToStorage;
    saveSummaryDataToStorage = function() {
      // 调用原始函数
      originalSaveSummaryDataToStorage();
      
      // 重新加载数据以更新分页
      loadSummaryDataFromStorage();
    };
    
    // 待办事项功能实现
    function initTodoList() {
      const todoListEl = document.getElementById('todoList');
      const addTodoBtn = document.getElementById('addTodoBtn');
      const todoSearch = document.getElementById('todoSearch');
      let allTodos = JSON.parse(localStorage.getItem('todoList') || '[]');
      
      // 从localStorage加载待办事项
      function loadTodos() {
        allTodos = JSON.parse(localStorage.getItem('todoList') || '[]');
        renderTodos(allTodos);
      }
      
      // 保存待办事项到localStorage
      function saveTodos(todos) {
        localStorage.setItem('todoList', JSON.stringify(todos));
        allTodos = todos;
        filterTodos();
      }
      
      // 过滤待办事项
      function filterTodos() {
        const searchTerm = todoSearch.value.toLowerCase().trim();
        if (!searchTerm) {
          renderTodos(allTodos);
          return;
        }
        
        const filteredTodos = allTodos.filter(todo => 
          todo.text.toLowerCase().includes(searchTerm) ||
          (todo.createdAt && todo.createdAt.toLowerCase().includes(searchTerm))
        );
        renderTodos(filteredTodos);
      }
      
      // 渲染待办事项列表
      function renderTodos(todos) {
        if (todos.length === 0) {
          todoListEl.innerHTML = `
            <div class="text-gray-500 text-center py-4">
              <i class="fa fa-info-circle mr-2"></i>暂无待办事项
            </div>
          `;
          return;
        }
        
        todoListEl.innerHTML = todos.map((todo, index) => `
          <div class="flex items-center justify-between bg-white p-3 rounded border border-gray-200 shadow-sm">
            <div class="flex items-start flex-1">
              <input type="checkbox" id="todo-${index}" class="todo-checkbox mt-1 mr-3" data-index="${index}" ${todo.completed ? 'checked' : ''}>
              <label for="todo-${index}" class="text-sm flex-1 ${todo.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${todo.text}</label>
            </div>
            <button class="delete-todo text-gray-400 hover:text-danger ml-2" data-index="${index}">
              <i class="fa fa-times"></i>
            </button>
          </div>
        `).join('');
        
        // 添加事件监听器
        document.querySelectorAll('.todo-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', handleTodoComplete);
        });
        
        document.querySelectorAll('.delete-todo').forEach(button => {
          button.addEventListener('click', handleTodoDelete);
        });
      }
      
      // 处理待办事项完成状态变更
      function handleTodoComplete(e) {
        const index = parseInt(e.target.dataset.index);
        const todos = JSON.parse(localStorage.getItem('todoList') || '[]');
        todos[index].completed = e.target.checked;
        saveTodos(todos);
      }
      
      // 处理待办事项删除
      function handleTodoDelete(e) {
        const index = parseInt(e.target.closest('.delete-todo').dataset.index);
        const todos = JSON.parse(localStorage.getItem('todoList') || '[]');
        todos.splice(index, 1);
        saveTodos(todos);
      }
      
      // 添加新待办事项
      function addTodo() {
        const todoText = prompt('请输入待办事项内容：');
        if (todoText && todoText.trim()) {
          const todos = JSON.parse(localStorage.getItem('todoList') || '[]');
          todos.push({
            text: todoText.trim(),
            completed: false,
            createdAt: new Date().toISOString()
          });
          saveTodos(todos);
        }
      }
      
      // 添加事件监听器
      if (addTodoBtn) {
        addTodoBtn.addEventListener('click', addTodo);
      }
      
      // 添加搜索事件监听器
      if (todoSearch) {
        todoSearch.addEventListener('input', filterTodos);
      }
      
      // 初始加载
      loadTodos();
    }
    
    // 图表相关功能
    let salaryChart = null;
    
    // 从本地存储获取并处理工资数据
    function getSalaryDataByTimeRange(range, year) {
      const storedData = localStorage.getItem('salarySummaryData');
      if (!storedData) return { labels: [], data: [], hasData: false };
      
      const salaryData = JSON.parse(storedData);
      const groupedData = {};
      
      // 按年/月分组数据
      salaryData.forEach(item => {
        // 检查是否为指定年份的数据
        if (item.year && item.year.toString() === year.toString()) {
          const month = String(item.month).padStart(2, '0');
          const key = `${year}年${month}月`;
          
          if (!groupedData[key]) {
            groupedData[key] = 0;
          }
          // 累加实发工资
          groupedData[key] += parseFloat(item.netSalary || 0);
        }
      });
      
      // 对月份进行排序
      const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
      const sortedKeys = [];
      
      if (range === 'month') {
        // 按月查看时，确保12个月份都有，即使没有数据
        months.forEach(month => {
          const key = `${year}年${month}月`;
          sortedKeys.push(key);
          if (!groupedData[key]) {
            groupedData[key] = 0;
          }
        });
      } else {
        // 按年查看时，只显示有数据的月份
        months.forEach(month => {
          const key = `${year}年${month}月`;
          if (groupedData[key] !== undefined) {
            sortedKeys.push(key);
          }
        });
      }
      
      const hasData = Object.values(groupedData).some(value => value > 0);
      
      return {
        labels: sortedKeys,
        data: sortedKeys.map(key => groupedData[key]),
        hasData: hasData
      };
    }
    
    // 绘制工资统计图表
    function drawSalaryChart(range, year) {
      const ctx = document.getElementById('salaryChart');
      const chartNoData = document.getElementById('chartNoData');
      
      // 销毁已存在的图表
      if (salaryChart) {
        salaryChart.destroy();
      }
      
      // 获取数据
      const { labels, data, hasData } = getSalaryDataByTimeRange(range, year);
      
      // 显示/隐藏无数据提示
      if (!hasData) {
        ctx.style.display = 'none';
        chartNoData.classList.remove('hidden');
        return;
      }
      
      ctx.style.display = 'block';
      chartNoData.classList.add('hidden');
      
      // 计算全年工资总额
      const totalYearSalary = data.reduce((sum, value) => sum + value, 0);
      
      // 创建新图表
      salaryChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '全体员工总工资（元）',
            data: data,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: `${year}年${range === 'year' ? '各月' : ''}工资统计${range === 'year' ? ` - 全年总额: ¥${totalYearSalary.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}`
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `总工资: ¥${context.parsed.y.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '¥' + value.toLocaleString('zh-CN');
                }
              }
            }
          }
        },
        plugins: [{
          id: 'customLabels',
          afterDraw: function(chart) {
            const ctx = chart.ctx;
            const chartArea = chart.chartArea;
            const scales = chart.scales;
            const datasets = chart.data.datasets;
            
            datasets.forEach((dataset, datasetIndex) => {
              const meta = chart.getDatasetMeta(datasetIndex);
              meta.data.forEach((bar, index) => {
                const value = dataset.data[index];
                if (value === 0) return;
                
                // 获取柱形的位置
                const x = bar.x;
                const y = bar.y;
                
                // 计算文本位置
                ctx.save();
                ctx.font = 'bold 12px Arial';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                
                // 绘制文本
                ctx.fillText(`¥${value.toLocaleString('zh-CN')}`, x, y - 5);
                ctx.restore();
              });
            });
          }
        }]
      });
    }
    
    // 查看工资汇总详情
    function viewSalarySummary(employeeId, year, month) {
      // 获取汇总数据
      const storedData = localStorage.getItem('salarySummaryData');
      const summaryData = storedData ? JSON.parse(storedData) : [];
      
      // 查找对应的数据项
      const dataItem = summaryData.find(item => (item.id === employeeId || item.employeeId === employeeId) && item.year === year && item.month === month);
      
      if (dataItem) {
        // 创建详情模态框
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <div class="p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">${dataItem.year}年${dataItem.month}月工资详情 - ${dataItem.name}</h3>
                <button class="text-gray-500 hover:text-gray-700" onclick="document.body.removeChild(this.closest('.fixed'))">
                  <i class="fa fa-times text-xl"></i>
                </button>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><strong>工号:</strong> ${dataItem.employeeId}</div>
                <div><strong>姓名:</strong> ${dataItem.name}</div>
                <div><strong>身份证号:</strong> ${dataItem.idCard}</div>
                <div><strong>手机号:</strong> ${dataItem.phone}</div>
                <div><strong>银行卡号:</strong> ${dataItem.bankCard}</div>
                <div><strong>所属公司:</strong> ${dataItem.company}</div>
                <div><strong>出勤天数:</strong> ${dataItem.attendanceDays}天</div>
                <div><strong>基本工资:</strong> ¥${dataItem.basicSalary.toFixed(2)}</div>
                <div><strong>绩效奖:</strong> ¥${dataItem.performanceBonus.toFixed(2)}</div>
                <div><strong>房贴:</strong> ¥${dataItem.housingAllowance.toFixed(2)}</div>
                <div><strong>其它补贴:</strong> ¥${dataItem.otherAllowance.toFixed(2)}</div>
                <div><strong>年终奖:</strong> ¥${dataItem.yearEndBonus.toFixed(2)}</div>
                <div><strong>代扣个人社保:</strong> ¥${dataItem.socialSecurity.toFixed(2)}</div>
                <div><strong>代扣公积金:</strong> ¥${dataItem.providentFund.toFixed(2)}</div>
                <div><strong>扣借款:</strong> ¥${dataItem.loanDeduction.toFixed(2)}</div>
                <div><strong>代扣个税:</strong> ¥${dataItem.incomeTax.toFixed(2)}</div>
                <div class="md:col-span-2"><strong>备注:</strong> ${dataItem.remarks || '-'}</div>
              </div>
              <div class="mt-6 p-4 bg-gray-50 rounded-md">
                <div class="flex justify-between items-center font-bold text-lg text-primary">
                  <span>实发工资:</span>
                  <span>¥${dataItem.netSalary.toFixed(2)}</span>
                </div>
              </div>
              <div class="mt-6 flex justify-end">
                <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors" onclick="document.body.removeChild(this.closest('.fixed'))">
                  关闭
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
    }
    
    // 编辑工资汇总数据
    function editSalarySummary(employeeId, year, month) {
      // 获取汇总数据
      const storedData = localStorage.getItem('salarySummaryData');
      const summaryData = storedData ? JSON.parse(storedData) : [];
      
      // 查找对应的数据项
      const dataItem = summaryData.find(item => (item.id === employeeId || item.employeeId === employeeId) && item.year === year && item.month === month);
      
      if (dataItem) {
        // 创建编辑模态框
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">编辑${dataItem.year}年${dataItem.month}月工资 - ${dataItem.name}</h3>
                <button class="text-gray-500 hover:text-gray-700" onclick="document.body.removeChild(this.closest('.fixed'))">
                  <i class="fa fa-times text-xl"></i>
                </button>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="p-2"><strong>工号:</strong> ${dataItem.employeeId}</div>
                <div class="p-2"><strong>姓名:</strong> ${dataItem.name}</div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">出勤天数</label>
                  <input type="number" id="editAttendanceDays" value="${dataItem.attendanceDays}" min="0" max="31" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">基本工资</label>
                  <input type="number" id="editBasicSalary" value="${dataItem.basicSalary.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">绩效奖</label>
                  <input type="number" id="editPerformanceBonus" value="${dataItem.performanceBonus.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">房贴</label>
                  <input type="number" id="editHousingAllowance" value="${dataItem.housingAllowance.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">其它补贴</label>
                  <input type="number" id="editOtherAllowance" value="${dataItem.otherAllowance.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">年终奖</label>
                  <input type="number" id="editYearEndBonus" value="${dataItem.yearEndBonus.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">代扣个人社保</label>
                  <input type="number" id="editSocialSecurity" value="${dataItem.socialSecurity.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">代扣公积金</label>
                  <input type="number" id="editProvidentFund" value="${dataItem.providentFund.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">扣借款</label>
                  <input type="number" id="editLoanDeduction" value="${dataItem.loanDeduction.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">代扣个税</label>
                  <input type="number" id="editIncomeTax" value="${dataItem.incomeTax.toFixed(2)}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                  <textarea id="editRemarks" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="3">${dataItem.remarks}</textarea>
                </div>
              </div>
              <div class="mt-6 p-4 bg-gray-50 rounded-md">
                <div class="flex justify-between items-center font-bold text-lg text-primary">
                  <span>实发工资:</span>
                  <span id="editNetSalary">¥${dataItem.netSalary.toFixed(2)}</span>
                </div>
              </div>
              <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors" onclick="document.body.removeChild(this.closest('.fixed'))">
                  取消
                </button>
                <button class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90 transition-colors" onclick="saveEditedSummary('${employeeId}', ${year}, ${month}, this.closest('.fixed'))">
                  保存
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // 添加输入事件监听器，实时计算实发工资
        const inputs = modal.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          input.addEventListener('input', function() {
            calculateEditedNetSalary();
          });
        });
      }
    }
    
    // 计算编辑模式下的实发工资
    function calculateEditedNetSalary() {
      const basicSalary = parseFloat(document.getElementById('editBasicSalary').value) || 0;
      const performanceBonus = parseFloat(document.getElementById('editPerformanceBonus').value) || 0;
      const housingAllowance = parseFloat(document.getElementById('editHousingAllowance').value) || 0;
      const otherAllowance = parseFloat(document.getElementById('editOtherAllowance').value) || 0;
      const yearEndBonus = parseFloat(document.getElementById('editYearEndBonus').value) || 0;
      const socialSecurity = parseFloat(document.getElementById('editSocialSecurity').value) || 0;
      const providentFund = parseFloat(document.getElementById('editProvidentFund').value) || 0;
      const loanDeduction = parseFloat(document.getElementById('editLoanDeduction').value) || 0;
      const incomeTax = parseFloat(document.getElementById('editIncomeTax').value) || 0;
      
      const grossSalary = basicSalary + performanceBonus + housingAllowance + otherAllowance + yearEndBonus;
      const totalDeductions = socialSecurity + providentFund + loanDeduction + incomeTax;
      const netSalary = grossSalary - totalDeductions;
      
      document.getElementById('editNetSalary').textContent = `¥${netSalary.toFixed(2)}`;
    }
    
    // 保存编辑后的汇总数据
    function saveEditedSummary(employeeId, year, month, modalElement) {
      // 获取汇总数据
      const storedData = localStorage.getItem('salarySummaryData');
      let summaryData = storedData ? JSON.parse(storedData) : [];
      
      // 查找对应的数据项索引
      const dataIndex = summaryData.findIndex(item => (item.id === employeeId || item.employeeId === employeeId) && item.year === year && item.month === month);
      
      if (dataIndex !== -1) {
        // 更新数据
        summaryData[dataIndex].attendanceDays = parseFloat(document.getElementById('editAttendanceDays').value) || 0;
        summaryData[dataIndex].basicSalary = parseFloat(document.getElementById('editBasicSalary').value) || 0;
        summaryData[dataIndex].performanceBonus = parseFloat(document.getElementById('editPerformanceBonus').value) || 0;
        summaryData[dataIndex].housingAllowance = parseFloat(document.getElementById('editHousingAllowance').value) || 0;
        summaryData[dataIndex].otherAllowance = parseFloat(document.getElementById('editOtherAllowance').value) || 0;
        summaryData[dataIndex].yearEndBonus = parseFloat(document.getElementById('editYearEndBonus').value) || 0;
        summaryData[dataIndex].socialSecurity = parseFloat(document.getElementById('editSocialSecurity').value) || 0;
        summaryData[dataIndex].providentFund = parseFloat(document.getElementById('editProvidentFund').value) || 0;
        summaryData[dataIndex].loanDeduction = parseFloat(document.getElementById('editLoanDeduction').value) || 0;
        summaryData[dataIndex].incomeTax = parseFloat(document.getElementById('editIncomeTax').value) || 0;
        summaryData[dataIndex].remarks = document.getElementById('editRemarks').value;
        
        // 重新计算实发工资
        const grossSalary = summaryData[dataIndex].basicSalary + summaryData[dataIndex].performanceBonus + 
                          summaryData[dataIndex].housingAllowance + summaryData[dataIndex].otherAllowance + 
                          summaryData[dataIndex].yearEndBonus;
        const totalDeductions = summaryData[dataIndex].socialSecurity + summaryData[dataIndex].providentFund + 
                              summaryData[dataIndex].loanDeduction + summaryData[dataIndex].incomeTax;
        summaryData[dataIndex].netSalary = grossSalary - totalDeductions;
        
        // 保存更新后的数据
        localStorage.setItem('salarySummaryData', JSON.stringify(summaryData));
        
        // 重新加载汇总表格
        loadSummaryDataFromStorage();
        
        // 如果有搜索结果表格，则实时更新
        if (window.currentSearchResults && window.currentSearchResults.length > 0) {
          // 从localStorage重新获取最新数据
          const storedData = localStorage.getItem('salarySummaryData');
          const summaryData = storedData ? JSON.parse(storedData) : [];
          
          // 重新筛选搜索结果
          const resultContainer = document.getElementById('searchResultContainer');
          if (resultContainer && !resultContainer.classList.contains('hidden')) {
            // 获取当前搜索条件
            const company = document.getElementById('searchCompany').value;
            const startYear = document.getElementById('searchStartYear').value;
            const startMonth = document.getElementById('searchStartMonth').value;
            const endYear = document.getElementById('searchEndYear').value;
            const endMonth = document.getElementById('searchEndMonth').value;
            const employeeName = document.getElementById('searchEmployeeName').value.trim().toLowerCase();
            const employeeId = document.getElementById('searchEmployeeId').value.trim().toLowerCase();
            const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            
            // 重新筛选数据
            let filteredData = summaryData.filter(item => {
              // 公司筛选
              if (company && item.company !== company) return false;
              
              // 时间范围筛选
              const itemYearMonth = item.year * 100 + item.month;
              if (startYear && startMonth) {
                const startYearMonth = parseInt(startYear) * 100 + parseInt(startMonth);
                if (itemYearMonth < startYearMonth) return false;
              }
              if (endYear && endMonth) {
                const endYearMonth = parseInt(endYear) * 100 + parseInt(endMonth);
                if (itemYearMonth > endYearMonth) return false;
              }
              
              // 员工筛选
              if (employeeName && !item.name.toLowerCase().includes(employeeName)) return false;
              if (employeeId && !item.employeeId.toLowerCase().includes(employeeId)) return false;
              
              // 关键词搜索（搜索所有字段）
              if (keyword) {
                const keywordLower = keyword.toLowerCase();
                return Object.values(item).some(value => {
                  if (value === null || value === undefined) return false;
                  return String(value).toLowerCase().includes(keywordLower);
                });
              }
              
              return true;
            });
            
            // 更新搜索结果
            displaySearchResults(filteredData);
          }
        }
        
        // 显示保存成功提示
        showToast('工资数据已成功更新');
        
        // 关闭模态框
        document.body.removeChild(modalElement);
      }
    }
    
    // 初始化图表功能
    function initSalaryChart() {
      const chartTimeRange = document.getElementById('chartTimeRange');
      const chartYearFilter = document.getElementById('chartYearFilter');
      
      if (chartTimeRange && chartYearFilter) {
        // 初始绘制图表
        drawSalaryChart(chartTimeRange.value, chartYearFilter.value);
        
        // 监听时间范围变化
        chartTimeRange.addEventListener('change', () => {
          drawSalaryChart(chartTimeRange.value, chartYearFilter.value);
        });
        
        // 监听年份变化
        chartYearFilter.addEventListener('change', () => {
          drawSalaryChart(chartTimeRange.value, chartYearFilter.value);
        });
      }
    }
    
    // 初始化分页事件
    initPaginationEvents();
    
    // 初始化待办事项功能
    initTodoList();
    
    // 处理Excel文件导入
    function handleExcelImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // 检查文件类型
      if (!file.name.match(/\.(xlsx|xls)$/)) {
        showToast('请选择有效的Excel文件(.xlsx或.xls格式)', true);
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // 假设第一个工作表是数据所在的表
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // 将工作表转换为JSON数据
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        // 处理导入的数据
        processImportedData(jsonData);
      };
      
      reader.readAsArrayBuffer(file);
      
      // 清空文件输入，以便可以重新选择同一个文件
      e.target.value = '';
    }
    
    // 处理导入的数据
    function processImportedData(importedData) {
      if (!importedData || importedData.length === 0) {
        showToast('Excel文件中没有数据', true);
        return;
      }
      
      let importedCount = 0;
      let skippedCount = 0;
      
      // 定义字段映射关系
      const fieldMapping = {
        '出勤天数': 'attendanceDays',
        '生产工资': 'basicSalary',
        '考勤奖': 'performanceBonus',
        '房贴': 'housingAllowance',
        '其它补贴': 'otherAllowance'
      };
      
      // 遍历导入的数据
      importedData.forEach(row => {
        const importedName = row['姓名'];
        if (!importedName) {
          skippedCount++;
          return;
        }
        
        // 在工资表中查找同名员工
        const employeeIndex = salaryData.findIndex(item => item.name === importedName);
        if (employeeIndex === -1) {
          skippedCount++;
          return;
        }
        
        // 更新员工数据
        let dataUpdated = false;
        Object.keys(fieldMapping).forEach(excelField => {
          if (row[excelField] !== undefined) {
            const systemField = fieldMapping[excelField];
            const value = parseFloat(row[excelField]) || 0;
            salaryData[employeeIndex][systemField] = value;
            dataUpdated = true;
          }
        });
        
        if (dataUpdated) {
          // 重新计算实发工资
          calculateNetSalary(employeeIndex);
          importedCount++;
          isDataModified = true;
        }
      });
      
      // 重新渲染工资表
      renderSalaryTable();
      
      // 显示导入结果
      let message = `成功导入 ${importedCount} 条记录`;
      if (skippedCount > 0) {
        message += `，跳过 ${skippedCount} 条记录（姓名不存在或没有数据）`;
      }
      showToast(message, false);
    }
    
    // 显示提示信息
    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      // 3秒后自动隐藏
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }
  </script>
  </body>
</html>
